---
title: "R00 Interaction Analyses"
author: "Ethan Walker"
date: "27 July 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
library(gamm4)
library(sjstats)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

# Creating datasets for various analyses
```{r}
# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")

r00_model_data <- r00_model_data_outliers_removed %>% 
  # removes 6 observations for participant who wasn't assigned to a study arm
  filter(!is.na(study_arm)) %>% 
  # removes 22 observations for pregnancies
  filter(pregnant_new == 0) %>% 
  # further removes 196 observations (n=1162)
  filter(!is.na(aug_index)) 

# Dataset for participants who have AIx data for all 6 Phases (107 participants)
r00_data_6phases <- r00_model_data %>%
  group_by(house_id) %>% 
  #create new var to be able to filter for participants that completed 6 phases
  mutate(phase_complete = if_else(!is.na(aug_index), 1, 0)) %>% 
  filter(sum(phase_complete) == 6) %>% 
  ungroup()
  

# Dataset for participants who have AIx data for all <6 Phases
r00_data_5phases <- r00_model_data %>%
  group_by(house_id) %>% 
  #create new var to be able to filter for participants that completed 6 phases
  mutate(phase_complete = if_else(!is.na(aug_index), 1, 0)) %>% 
  filter(sum(phase_complete) < 6) %>% 
  ungroup() 


# Dataset removing 46 participants who missed AIx in phase 2 from sphygmo malfunction
r00_data_sphygmo_p2 <- r00_model_data_outliers_removed %>%
  # removes 6 observations for participant who wasn't assigned to a study arm
  filter(!is.na(study_arm)) %>% 
  mutate(sphygmo_missing_phase2 = as.numeric(sys_bp_final_nurse),
         sphygmo_missing_phase2 = if_else(sphygmo_missing_phase2 > 1, 1, 0),
         sphygmo_missing_phase2 = if_else(is.na(sphygmo_missing_phase2),
                                          0, sphygmo_missing_phase2)) %>%
  group_by(house_id) %>%
  filter(sum(sphygmo_missing_phase2) == 0) %>% 
  ungroup() %>% 
  filter(pregnant_new == 0) %>% 
  filter(!is.na(aug_index))  # 949 obs from 184 participants  


# Filtering out medication users (n=34 obs)
r00_model_data_meds <- r00_model_data %>% 
  #filtering out bp med users
  filter(is.na(med_bp)) 
```

### PM interaction analysis
```{r}
## Use these vars as interaction terms
# Age split at 40: age_cat_40
# Waist split at 80: waist_cat
# Blood pressure: bp_cat
# Hba1c: hba1c_cat
# Metabolic Syndrome: met_syn

# AIx and area pm
model_apm_int <- lmer(aug_index ~ log_a_twa*met_syn + ns(date_sphygmo, df=6) +
                      waist_cm + school_bi + age_baseline + 
                      (1 | house_id), r00_model_data)
   #summary(model_apm_int)
int_emtrends <- emtrends(model_apm_int, pairwise ~ met_syn, var = "log_a_twa")
# This summary gives estimates, confidence intervals, and p-values
summary(int_emtrends, conf.int = TRUE)
# This line will plot the interaction term
emmip(model_apm_int, met_syn ~ log_a_twa, cov.reduce = range)

############################################################
# AIx and personal pm
model_ppm_int <- lmer(aug_index ~ log_p_twa*met_syn + ns(date_sphygmo, df=6) +
                      waist_cm + school_bi + age_baseline + 
                      (1 | house_id), r00_model_data)
   #summary(model_ppm_int)
int_emtrends <- emtrends(model_ppm_int, pairwise ~ met_syn, var = "log_p_twa")
summary(int_emtrends, conf.int = TRUE)
#emmip(model_ppm_int, waist_cat ~ log_p_twa, cov.reduce = range)

############################################################
# CPP and area pm
model_apm_int <- lmer(pulse_pressure_central ~ log_a_twa*met_syn + 
                      ns(date_sphygmo, df=6) + age_baseline + waist_cm + 
                      school_bi + (1 | house_id), r00_model_data)
   #summary(model_apm_int)
int_emtrends <- emtrends(model_apm_int, pairwise ~ met_syn, var = "log_a_twa")
summary(int_emtrends, conf.int = TRUE)
#emmip(model_apm_int, waist_cat ~ log_a_twa, cov.reduce = range)

############################################################
# CPP and personal pm
model_ppm_int <- lmer(pulse_pressure_central ~ log_p_twa*met_syn + 
                      ns(date_sphygmo, df=6) + age_baseline + waist_cm + 
                      school_bi + (1 | house_id), r00_model_data)
   #summary(model_ppm_int)
int_emtrends <- emtrends(model_ppm_int, pairwise ~ met_syn, var = "log_p_twa")
summary(int_emtrends, conf.int = TRUE)
#emmip(model_ppm_int, waist_cat ~ log_p_twa, cov.reduce = range)
```

### ITT interaction analysis
```{r}
# Age split at 40: age_cat_40
# Waist split at 80: waist_cat
# Blood pressure: bp_cat
# Hba1c: hba1c_cat
# Metabolic Syndrome: met_syn

# AIx
sphygmo_model_int <- lmer(aug_index ~ assigned_stove*met_syn + 
                          ns(date_sphygmo, df=6) + (1 | house_id), r00_model_data)
# Use this summary to get p-value for interaction term
summary(sphygmo_model_int)
int_emmeans <- emmeans(sphygmo_model_int, pairwise ~ assigned_stove | met_syn)
#summary(int_emmeans)
# Use this summary for estimates and confidence intervals
confint(int_emmeans)
# This line will plot the interaction term
#emmip(sphygmo_model_int, age_cat_40 ~ assigned_stove, cov.reduce = range)

############################################################
# CPP
sphygmo_model_int <- lmer(pulse_pressure_central ~ assigned_stove*met_syn + 
                          ns(date_sphygmo, df=6) + (1 | house_id), r00_model_data)
summary(sphygmo_model_int)
int_emmeans <- emmeans(sphygmo_model_int, pairwise ~ assigned_stove | met_syn)
#summary(int_emmeans, conf.int = TRUE)
confint(int_emmeans)
# This line will plot the interaction term
#emmip(sphygmo_model_int, age_cat_40 ~ assigned_stove, cov.reduce = range)
```
