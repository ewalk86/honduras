---
title: "R00 Interaction Analyses"
author: "Ethan Walker"
date: "May 9, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
library(gamm4)
library(sjstats)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx (10 total)
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")

## Data prep - primary model dataset
r00_model_data <- r00_model_data_outliers_removed %>% 
  filter(!is.na(assigned_stove)) %>% 
  filter(pregnant_new == 0) 

# Dataset for participants who did not miss phase 2
r00_model_data_phase2 <- r00_model_data %>% 
  mutate(phase2 = 1) %>% 
  mutate(phase2 = if_else(phase == 2 & is.na(aug_index), 0, phase2)) %>%  
  group_by(house_id) %>% 
  filter(sum(phase2) == 6) %>% 
  ungroup() 
```

### PM interaction analysis
```{r}
# Age split at 40: age_cat_40
# Waist split at 80: waist_cat
# Blood pressure: bp_cat
# Hba1c: hba1c_cat
# Metabolic Syndrome: met_syn

# AIx and area pm
model_apm_int <- lmer(aug_index ~ log_a_twa*waist_cat + ns(date_sphygmo, df=6) +
                      waist_cm + school_bi + age_baseline + 
                      (1 | house_id), r00_model_data_phase2)
   #summary(model_apm_int)
int_emtrends <- emtrends(model_apm_int, pairwise ~ waist_cat, var = "log_a_twa")
summary(int_emtrends, conf.int = TRUE)
emmip(model_apm_int, waist_cat ~ log_a_twa, cov.reduce = range)

# AIx and personal pm
model_ppm_int <- lmer(aug_index ~ log_p_twa*waist_cat + ns(date_sphygmo, df=6) +
                      waist_cm + school_bi + age_baseline + 
                      (1 | house_id), r00_model_data_phase2)
   #summary(model_ppm_int)
int_emtrends <- emtrends(model_ppm_int, pairwise ~ waist_cat, var = "log_p_twa")
summary(int_emtrends, conf.int = TRUE)
emmip(model_ppm_int, waist_cat ~ log_p_twa, cov.reduce = range)

# CPP and area pm
model_apm_int <- lmer(pulse_pressure_central ~ log_a_twa*waist_cat + 
                      ns(date_sphygmo, df=6) + age_baseline + waist_cm + 
                      school_bi + (1 | house_id), r00_model_data_phase2)
   #summary(model_apm_int)
int_emtrends <- emtrends(model_apm_int, pairwise ~ waist_cat, var = "log_a_twa")
summary(int_emtrends, conf.int = TRUE)
emmip(model_apm_int, waist_cat ~ log_a_twa, cov.reduce = range)

# CPP and personal pm
model_ppm_int <- lmer(pulse_pressure_central ~ log_p_twa*waist_cat + 
                      ns(date_sphygmo, df=6) + age_baseline + waist_cm + 
                      school_bi + (1 | house_id), r00_model_data_phase2)
   #summary(model_ppm_int)
int_emtrends <- emtrends(model_ppm_int, pairwise ~ waist_cat, var = "log_p_twa")
summary(int_emtrends, conf.int = TRUE)
emmip(model_ppm_int, waist_cat ~ log_p_twa, cov.reduce = range)
```

### ITT interaction analysis
```{r}
# Age split at 40: age_cat_40
# Waist split at 80: waist_cat
# Blood pressure: bp_cat
# Hba1c: hba1c_cat
# Metabolic Syndrome: met_syn

# AIx
sphygmo_model_int <- lmer(aug_index ~ assigned_stove*met_syn + 
                          ns(date_sphygmo, df=6) + (1 | house_id), r00_model_data_phase2)
int_emmeans <- emmeans(sphygmo_model_int, pairwise ~ assigned_stove | met_syn)
summary(sphygmo_model_int)
summary(int_emmeans)
confint(int_emmeans)
emmip(sphygmo_model_int, met_syn ~ assigned_stove, cov.reduce = range)

# CPP
sphygmo_model_int <- lmer(pulse_pressure_central ~ assigned_stove*met_syn + 
                          ns(date_sphygmo, df=6) + (1 | house_id), r00_model_data_phase2)
summary(sphygmo_model_int)
int_emmeans <- emmeans(sphygmo_model_int, pairwise ~ assigned_stove | met_syn)
summary(int_emmeans, conf.int = TRUE)
confint(int_emmeans)
emmip(sphygmo_model_int, met_syn ~ assigned_stove, cov.reduce = range)
```
