---
title: "Honduras R00 Models and Estimate Plots"
author: "Ethan Walker"
date: "17 Nov 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
```

```{r}
r00_full_long_17nov2018_ew <- read_xlsx("input/r00_full_long_17nov2018_ew.csv")

r00_full_repeated_by_phase <- read_rds("output/r00_full_repeated_by_phase.rds")
```

## Data prep
```{r}
r00_model_data <- r00_full_repeated_by_phase %>% 
  mutate(sysbp = as.numeric(sysbp))%>% 
  mutate(diabp = as.numeric(diabp)) %>% 
  mutate(aix = as.numeric(aix)) %>% 
  mutate(phase = as.factor(phase)) %>%
  mutate(house_id = as.factor(house_id)) %>%
  #split age at 40
  mutate(age_cat = if_else(age_baseline > 40, 1, 0)) %>% 
  select(sysbp, diabp, aix, assigned_stove, date, house_id, age, age_current, phase) %>% 
  #format date var
  separate(date, c("month_time", "year"), sep = "UTC ") %>%
  separate(month_time, c("month_day", "time"), sep = " 00:00:00") %>%
  separate(month_day, c("month_day", "month", "day"), sep = " ") %>% 
  unite(date, c("day", "month", "year"), sep = " ") %>% 
  mutate(date = dmy(date)) %>% 
  select(-month_day, -time)
```


## Honduras R00 Initial AIx Model ##
```{r}
#run/save models
aix_model_spline <- lmer(aix ~ assigned_stove + ns(date, df=12) + 
                          (1 | house_id), r00_model_data)

aix_model_phase <- lmer(aix ~ assigned_stove + phase + 
                         (1 | house_id), r00_model_data)

aix_model <- lmer(aix ~ assigned_stove + (1 | house_id), r00_model_data)


#print model summaries
summary(aix_model_spline)

summary(aix_model_phase)

summary(aix_model)


# save model results
write_rds(aix_model, "output/aix_model_17nov18.RDS")
```

## Honduras R00 Initial BP Model ##
```{r}
bp_model_spline <- lmer(sysbp ~ assigned_stove + ns(date, df=12) + 
                          (1 | house_id), r00_model_data)

bp_model_phase <- lmer(sysbp ~ assigned_stove + phase + 
                         (1 | house_id), r00_model_data)

bp_model <- lmer(sysbp ~ assigned_stove + (1 | house_id), r00_model_data)

summary(bp_model_spline)

summary(bp_model_phase)

summary(bp_model)


# save model results
write_rds(bp_model, "output/bp_model_17nov18.RDS")
```

## Format model output for plotting
```{r}
tidy_results_aix_model_spline <- tidy(aix_model_spline, conf.int = TRUE) %>% 
    filter(grepl('assigned', term)) %>% 
    rename(ci_low = conf.low, ci_hi = conf.high) %>% 
    mutate(term = if_else(term == "assigned_stove1", "justa", "na"))
```

## Plot model estimate
```{r}
plot_estimates <- tidy_results_aix_model_spline %>%
  ggplot() +
  geom_point(aes(x=1, y=estimate)) +
  geom_errorbar(aes(x=1, ymin=ci_low, ymax=ci_hi)) +
  theme_minimal() +
  geom_hline(yintercept = 0) +
  ggtitle(label = "R00 Augmentation Index Model") +
  labs(x = "")
plot_estimates
```
