---
title: "Honduras R00 PM Models and Plots"
author: "Ethan Walker"
date: "17 April 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
library(gamm4)
library(sjstats)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
#load full dataset
# r00_full_repeated_by_phase <- read_rds("output/r00_full_repeated_by_phase.rds")

# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx (10 total)
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")
```

```{r}
# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx
## This dataset has already been saved -- load using code above
#r00_model_data_outliers_removed <- r00_full_repeated_by_phase %>% 
# # removes 6 potential "outliers" with high or low AIx
#  # removes 4 potential "outliers" > 75mmHg CPP
#  filter(aug_index < 75 | is.na(aug_index)) %>% 
#  filter(aug_index > -25 | is.na(aug_index)) %>% 
#  filter(pulse_pressure_central < 75 | is.na(pulse_pressure_central))
#write_rds(r00_model_data_outliers_removed, "output/r00_model_data_outliers_removed.rds")
```


```{r}
## Data prep - primary model dataset
r00_model_data <- r00_model_data_outliers_removed %>% 
  select(sys_bp_central, dia_bp_central, aug_index, aug_index_75,
         pulse_pressure_periph, pulse_pressure_central, hr, bmi, waist,
         whr, whr_cat, age_baseline, phase, house_id, season, assigned_stove,
         dds_total, phys_act, school_self, school_bi, beds_new, ses_materials, 
         a_twa, p_twa, sys_bp_periph, dia_bp_periph, phase, date_sphygmo, med_bp) %>% 
  mutate(sys_bp_central = as.numeric(sys_bp_central))%>% 
  mutate(dia_bp_central = as.numeric(dia_bp_central)) %>% 
  mutate(aug_index = as.numeric(aug_index)) %>% 
  mutate(aug_index_75 = as.numeric(aug_index_75)) %>% 
  mutate(pulse_pressure_periph = as.numeric(pulse_pressure_periph))%>% 
  mutate(pulse_pressure_central = as.numeric(pulse_pressure_central)) %>% 
  mutate(hr = as.numeric(hr)) %>% 
  mutate(bmi = as.numeric(bmi)) %>% 
  mutate(whr = as.numeric(whr)) %>% 
  mutate(waist = as.numeric(waist)) %>% 
  mutate(waist_cm = as.numeric(waist * 2.54)) %>% 
  mutate(waist_cat = if_else(waist_cm < 79.9, "waist < 80cm", "waist >= 80cm")) %>% 
  mutate(dds_total = as.numeric(dds_total)) %>% 
  mutate(phys_act = as.numeric(phys_act)) %>% 
  mutate(beds_new = as.numeric(beds_new)) %>% 
  mutate(ses_materials = as.numeric(ses_materials)) %>% 
  mutate(school_self = as.numeric(school_self)) %>%
  mutate(age_baseline = as.numeric(age_baseline)) %>% 
  mutate(phase = as.factor(phase)) %>%
  mutate(house_id = as.factor(house_id)) %>%
  #split age at 40; >40 = 1, <=40 = 0
  mutate(age_cat = if_else(age_baseline >= 40, ">=40", "<40")) %>% 
  mutate(age_cat = as.factor(age_cat)) %>% 
  mutate(school_bi = as.factor(school_bi)) %>% 
  #split bmi at 26; >26 = 1, <=26 = 0
  mutate(bmi_cat = if_else(bmi >= 26, ">=26", "<26")) %>% 
  mutate(bmi_cat = as.factor(bmi_cat)) %>%
  mutate(whr_cat = as.factor(whr_cat)) %>% 
  mutate(season = as.factor(season)) %>%
  mutate(assigned_stove = factor(assigned_stove, levels = c(0, 1), 
                                 labels = c("Traditional", "Justa"))) %>% 
  #log transforming and standardizing based on IQR
  mutate(log_a_twa_iqr = as.numeric(log(a_twa)/1.78)) %>% 
  mutate(log_p_twa_iqr = as.numeric(log(p_twa)/1.14)) %>% 
  #standardizing based on IQR
  mutate(a_twa_iqr = as.numeric(a_twa/200)) %>% 
  mutate(p_twa_iqr = as.numeric(p_twa/75)) %>% 
  #log transforming
  mutate(log_a_twa = as.numeric(log(a_twa))) %>% 
  mutate(log_p_twa = as.numeric(log(p_twa))) 

# Filtering out medication users
r00_model_data_meds <- r00_model_data %>% 
  #filtering out bp med users
  filter(is.na(med_bp))

# Dataset for participants who have AIx data for all 6 Phases
r00_model_data_6phases <- r00_model_data %>% 
  group_by(house_id) %>% 
  #create new var to be able to filter for participants that completed 6 phases
  mutate(phase_complete = if_else(!is.na(aug_index), 1, 0)) %>% 
  filter(sum(phase_complete) == 6)


# Dataset where Phase 1 AIx observations are added as a new variable/column
r00_model_data_aix_baseline <- r00_model_data %>% 
  filter(!is.na(aug_index)) %>% 
  group_by(house_id) %>% 
  mutate(baseline_aix = if_else(phase == 1, aug_index, 9999)) %>% 
  mutate(baseline_aix_2 = lag(baseline_aix)) %>% 
  mutate(baseline_aix_3 = lag(baseline_aix_2)) %>% 
  mutate(baseline_aix_2 = if_else(baseline_aix_3 < 9999 & !is.na(baseline_aix_3), 
                                  baseline_aix_3, baseline_aix_2)) %>% 
  mutate(baseline_aix_3 = lag(baseline_aix_2)) %>% 
  mutate(baseline_aix_2 = if_else(baseline_aix_3 < 9999 & !is.na(baseline_aix_3), 
                                  baseline_aix_3, baseline_aix_2)) %>% 
  mutate(baseline_aix_3 = lag(baseline_aix_2)) %>% 
  mutate(baseline_aix_2 = if_else(baseline_aix_3 < 9999 & !is.na(baseline_aix_3), 
                                  baseline_aix_3, baseline_aix_2)) %>% 
  mutate(baseline_aix_3 = lag(baseline_aix_2)) %>% 
  mutate(baseline_aix_2 = if_else(baseline_aix_3 < 9999 & !is.na(baseline_aix_3), 
                                  baseline_aix_3, baseline_aix_2)) %>% 
  filter(phase != 1) %>% 
  mutate(baseline_aix = baseline_aix_2) %>% 
  select(-baseline_aix_2, -baseline_aix_3)


# Datasets for each Phase
r00_model_data_baseline <- r00_model_data %>% 
  filter(phase == 1)
r00_model_data_p2 <- r00_model_data %>% 
  filter(phase == 2)
r00_model_data_p3 <- r00_model_data %>% 
  filter(phase == 3)
r00_model_data_p4 <- r00_model_data %>% 
  filter(phase == 4)
r00_model_data_p5 <- r00_model_data %>% 
  filter(phase == 5)
r00_model_data_p6 <- r00_model_data %>% 
  filter(phase == 6)
```

# Primary analyses with a priori confounders
## use log transformed pm
## use splines initially, but try phase and season
## age_baseline and school_self have strong associations with outcomes 
### use in primary model
## whr and bmi have similar assocations with outcomes
### start with whr but try bmi
## beds_new and ses_materials have weak associations with outcomes
### add them to model one at a time and see if they make a difference
## phys_act and dds_total have weak associations with outcomes
### add them to model one at a time and see if they make a difference

# AIx and area PM
```{r}
##### AIx and area PM phase 1 only 

model_apm_p1 <- lm(aug_index ~ log_a_twa + age_baseline +
                       whr + school_self, r00_model_data_baseline)
#summary(model_apm_p1)
tidy_model_apm_p1 <- tidy(model_apm_p1, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phase 1", "na")) 



##### AIx and area PM initial model - spline with 6 df

model_apm <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm)
# Intraclass correlation coefficient
tidy_model_apm <- tidy(model_apm, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "primary", "na")) 

##### AIx and area PM initial model - bp meds removed (57 obs)

model_apm_no_bp_meds <- lmer(aug_index ~ log_a_twa + 
                                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_no_bp_meds)
tidy_model_apm_no_bp_meds <- tidy(model_apm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "no bp meds", "na")) 

##### AIx and area PM initial model - dichotomous confounders

model_apm_di_conf <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_cat +
                      waist_cat + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_di_conf)
tidy_model_apm_di_conf <- tidy(model_apm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "di confdrs", "na"))

##### AIx and area PM initial model - spline with 12 df

model_apm_spline12 <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=12) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_spline12)
tidy_model_apm_spline12 <- tidy(model_apm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 12 df", "na")) 

##### AIx and area PM 6 phases model 

model_apm_6phases <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data_6phases)
#summary(model_apm_6phases)
tidy_model_apm_6phases <- tidy(model_apm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "6 phases", "na")) 

##### AIx and area PM - adjust for baseline AIx 

model_apm_baseline <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + baseline_aix + (1 | house_id), 
                      r00_model_data_aix_baseline)
#summary(model_apm_baseline)
tidy_model_apm_baseline <- tidy(model_apm_baseline, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "baseline", "na")) 

##### AIx and area PM reduced model 

model_apm_reduced <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) 
                  + (1 | house_id), r00_model_data)
#summary(model_apm_reduced)
tidy_model_apm_reduced <- tidy(model_apm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "reduced", "na")) 

##### AIx and area PM initial model - phase instead of spline

model_apm_phase <- lmer(aug_index ~ log_a_twa + phase + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_phase)
tidy_model_apm_phase <- tidy(model_apm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phase", "na"))

##### AIx and area PM initial model - season instead of spline

model_apm_season <- lmer(aug_index ~ log_a_twa + season + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_season)
tidy_model_apm_season <- tidy(model_apm_season, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "season", "na"))

##### AIx and area PM initial model - bmi instead of waist_cm

model_apm_bmi <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_bmi)
tidy_model_apm_bmi <- tidy(model_apm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "bmi", "na"))

##### AIx and area PM initial model - whr instead of waist_cm

model_apm_whr <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_whr)
tidy_model_apm_whr <- tidy(model_apm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "whr", "na"))

##### AIx and area PM initial model - adding beds_new

model_apm_beds <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + beds_new + (1 | house_id), r00_model_data)
#summary(model_apm_beds)
tidy_model_apm_beds <- tidy(model_apm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "beds", "na"))

##### AIx and area PM initial model - adding ses_materials

model_apm_ses <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + ses_materials + (1 | house_id), r00_model_data)
#summary(model_apm_ses)
tidy_model_apm_ses <- tidy(model_apm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ses assets", "na"))

##### AIx and area PM initial model - adding phys_act

model_apm_pa <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + phys_act + (1 | house_id), r00_model_data)
#summary(model_apm_pa)
tidy_model_apm_pa <- tidy(model_apm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phys act", "na"))

##### AIx and area PM initial model - adding dds_total

model_apm_dds <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + (1 | house_id), r00_model_data)
#summary(model_apm_dds)
tidy_model_apm_dds <- tidy(model_apm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "dds", "na"))

##### AIx and area PM initial model - full model with all potential confounders

model_apm_full <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + phys_act +
                        ses_materials + beds_new + 
                        (1 | house_id), r00_model_data)
#summary(model_apm_full)
tidy_model_apm_full <- tidy(model_apm_full, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "full", "na"))



aix_results <- rbind(tidy_model_apm,
                     tidy_model_apm_no_bp_meds,
                     tidy_model_apm_di_conf,
                     tidy_model_apm_6phases,
                     tidy_model_apm_reduced,
                     tidy_model_apm_phase,
                     tidy_model_apm_season,
                     tidy_model_apm_spline12,
                     tidy_model_apm_bmi,
                     tidy_model_apm_whr,
                     tidy_model_apm_beds,
                     tidy_model_apm_ses,
                     tidy_model_apm_pa,
                     tidy_model_apm_dds,
                     tidy_model_apm_full)
kable(aix_results)
```


## Plot model estimates - AIx and Area PM
```{r}
plot_estimates <- aix_results %>%
  mutate(model = factor(model, levels = c("primary", "no bp meds",
                                          "di confdrs", "6 phases", "reduced",
                                          "spline 12 df", "phase", "season",
                                          "bmi", "whr", "beds", "ses assets", "dds",
                                          "phys act", "full"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "AIx Models - Area PM") +
  labs(y = "Estimate (%)") +
  labs(x = "") +
  theme(title = element_text(size = 19), 
          axis.text.x = element_text(angle = 25, hjust = 1, 
                                     size = 18, colour = "black"),
          axis.text.y = element_text(size = 18, colour = "black"),
          axis.title.y = element_text(size = 18),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank()) +
  scale_colour_manual(values=jvPalette) 
plot_estimates
```

# AIx primary model diagnostic plots - Area PM
```{r}
plot(model_apm, main = "AIx and area PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_apm), main = "AIx and area PM primary model")


#aix_influential <- influence(model_apm, obs = TRUE)

#aix_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(aix_influential, which = "cook")
```

---------------------------------

# AIx and personal PM
```{r}
##### AIx and personal PM phase 1 only 

model_ppm_p1 <- lm(aug_index ~ log_p_twa + age_baseline +
                       waist_cm + school_self, r00_model_data_baseline)
#summary(model_ppm_p1)
tidy_model_ppm_p1 <- tidy(model_ppm_p1, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phase 1", "na")) 




##### AIx and personal PM initial model 

model_ppm <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm)
tidy_model_ppm <- tidy(model_ppm, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "primary", "na")) 

##### AIx and personal PM initial model - bp meds removed (57 obs)

model_ppm_no_bp_meds <- lmer(aug_index ~ log_p_twa + 
                                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_no_bp_meds)
tidy_model_ppm_no_bp_meds <- tidy(model_ppm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "no bp meds", "na")) 

##### AIx and personal PM initial model - dichotomous confounders

model_ppm_di_conf <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_cat +
                      waist_cat + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_di_conf)
tidy_model_ppm_di_conf <- tidy(model_ppm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "di confdrs", "na"))

##### AIx and personal PM initial model - spline with 12 df

model_ppm_spline12 <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=12) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_spline12)
tidy_model_ppm_spline12 <- tidy(model_ppm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 12 df", "na")) 

##### AIx and personal PM 6 phases model 

model_ppm_6phases <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data_6phases)
#summary(model_ppm_6phases)
tidy_model_ppm_6phases <- tidy(model_ppm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "6 phases", "na")) 

##### AIx and personal PM - adjust for baseline AIx 

model_ppm_baseline <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + baseline_aix + (1 | house_id), 
                      r00_model_data_aix_baseline)
#summary(model_ppm_baseline)
tidy_model_ppm_baseline <- tidy(model_ppm_baseline, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "baseline", "na")) 

##### AIx and personal PM reduced model 

model_ppm_reduced <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) 
                  + (1 | house_id), r00_model_data)
#summary(model_ppm_reduced)
tidy_model_ppm_reduced <- tidy(model_ppm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "reduced", "na")) 

##### AIx and personal PM initial model - phase instead of spline

model_ppm_phase <- lmer(aug_index ~ log_p_twa + phase + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_phase)
tidy_model_ppm_phase <- tidy(model_ppm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phase", "na"))

##### AIx and personal PM initial model - season instead of spline

model_ppm_season <- lmer(aug_index ~ log_p_twa + season + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_season)
tidy_model_ppm_season <- tidy(model_ppm_season, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "season", "na"))

##### AIx and personal PM initial model - bmi instead of waist_cm

model_ppm_bmi <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_bmi)
tidy_model_ppm_bmi <- tidy(model_ppm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "bmi", "na"))

##### AIx and personal PM initial model - whr instead of waist_cm

model_ppm_whr <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_whr)
tidy_model_ppm_whr <- tidy(model_ppm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "whr", "na"))

##### AIx and personal PM initial model - adding beds_new

model_ppm_beds <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + beds_new + (1 | house_id), r00_model_data)
#summary(model_ppm_beds)
tidy_model_ppm_beds <- tidy(model_ppm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "beds", "na"))

##### AIx and personal PM initial model - adding ses_materials

model_ppm_ses <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + ses_materials + (1 | house_id), r00_model_data)
#summary(model_ppm_ses)
tidy_model_ppm_ses <- tidy(model_ppm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ses assets", "na"))

##### AIx and personal PM initial model - adding phys_act

model_ppm_pa <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + phys_act + (1 | house_id), r00_model_data)
#summary(model_ppm_pa)
tidy_model_ppm_pa <- tidy(model_ppm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phys act", "na"))

##### AIx and personal PM initial model - adding dds_total

model_ppm_dds <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + (1 | house_id), r00_model_data)
#summary(model_ppm_dds)
tidy_model_ppm_dds <- tidy(model_ppm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "dds", "na"))

##### AIx and personal PM initial model - full model with all potential confounders

model_ppm_full <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + phys_act +
                        ses_materials + beds_new + 
                        (1 | house_id), r00_model_data)
#summary(model_ppm_full)
tidy_model_ppm_full <- tidy(model_ppm_full, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "full", "na"))



aix_results <- rbind(tidy_model_ppm,
                     tidy_model_ppm_no_bp_meds,
                     tidy_model_ppm_di_conf,
                     tidy_model_ppm_6phases,
                     tidy_model_ppm_reduced,
                     tidy_model_ppm_phase,
                     tidy_model_ppm_season,
                     tidy_model_ppm_spline12,
                     tidy_model_ppm_bmi,
                     tidy_model_ppm_whr,
                     tidy_model_ppm_beds,
                     tidy_model_ppm_ses,
                     tidy_model_ppm_pa,
                     tidy_model_ppm_dds,
                     tidy_model_ppm_full)
kable(aix_results)
```

## Plot model estimates - AIx and Personal PM
```{r}
plot_estimates <- aix_results %>%
  mutate(model = factor(model, levels = c("primary", "no bp meds",
                                          "di confdrs", "6 phases", "reduced",
                                          "spline 12 df", "phase", "season",
                                          "bmi", "whr", "beds", "ses assets", "dds",
                                          "phys act", "full"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "AIx Models - Personal PM") +
  labs(y = "Estimate (%)") +
  labs(x = "") +
  theme(title = element_text(size = 19), 
          axis.text.x = element_text(angle = 25, hjust = 1, 
                                     size = 18, colour = "black"),
          axis.text.y = element_text(size = 18, colour = "black"),
          axis.title.y = element_text(size = 18),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank()) +
  scale_colour_manual(values=jvPalette) 
plot_estimates
```

# AIx primary model diagnostic plots - Personal PM
```{r}
plot(model_ppm, main = "AIx and personal PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_ppm), main = "AIx and personal PM primary model")


#aix_influential <- influence(model_ppm, obs = TRUE)

#aix_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(aix_influential, which = "cook")
```

---------------------------------

# CPP and area PM
```{r}
##### CPP and area PM phase 1 only 

model_apm_p1 <- lm(pulse_pressure_central ~ log_a_twa + age_baseline +
                       waist_cm + school_self, r00_model_data_baseline)
#summary(model_apm_p1)
tidy_model_apm_p1 <- tidy(model_apm_p1, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phase 1", "na")) 




##### CPP and area PM initial model 

model_apm <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm)
tidy_model_apm <- tidy(model_apm, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "primary", "na")) 

##### CPP and area PM initial model - bp meds removed (57 obs)

model_apm_no_bp_meds <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_no_bp_meds)
tidy_model_apm_no_bp_meds <- tidy(model_apm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "no bp meds", "na")) 

##### CPP and area PM initial model - dichotomous confounders

model_apm_di_conf <- lmer(pulse_pressure_central ~ log_a_twa + 
                            ns(date_sphygmo, df=6) + age_cat +
                      waist_cat + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_di_conf)
tidy_model_apm_di_conf <- tidy(model_apm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "di confdrs", "na"))

##### CPP and area PM model - spline with 12 df 

model_apm_spline12 <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=12) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_spline12)
tidy_model_apm_spline12 <- tidy(model_apm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 12 df", "na")) 

##### CPP and area PM 6 phases model 

model_apm_6phases <- lmer(pulse_pressure_central ~ log_a_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data_6phases)
#summary(model_apm_6phases)
tidy_model_apm_6phases <- tidy(model_apm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "6 phases", "na")) 

##### CPP and area PM reduced model 

model_apm_reduced <- lmer(pulse_pressure_central ~ log_a_twa + 
                            ns(date_sphygmo, df=6) 
                  + (1 | house_id), r00_model_data)
#summary(model_apm_reduced)
tidy_model_apm_reduced <- tidy(model_apm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "reduced", "na")) 

##### CPP and area PM initial model - phase instead of spline

model_apm_phase <- lmer(pulse_pressure_central ~ log_a_twa + phase + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_phase)
tidy_model_apm_phase <- tidy(model_apm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phase", "na"))

##### CPP and area PM initial model - season instead of spline

model_apm_season <- lmer(pulse_pressure_central ~ log_a_twa + season + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_season)
tidy_model_apm_season <- tidy(model_apm_season, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "season", "na"))

##### CPP and area PM initial model - bmi instead of waist_cm

model_apm_bmi <- lmer(pulse_pressure_central ~ log_a_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_bmi)
tidy_model_apm_bmi <- tidy(model_apm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "bmi", "na"))

##### CPP and area PM initial model - whr instead of waist_cm

model_apm_whr <- lmer(pulse_pressure_central ~ log_a_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_self + (1 | house_id), r00_model_data)
#summary(model_apm_whr)
tidy_model_apm_whr <- tidy(model_apm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "whr", "na"))

##### CPP and area PM initial model - adding beds_new

model_apm_beds <- lmer(pulse_pressure_central ~ log_a_twa + 
                         ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + beds_new + (1 | house_id), r00_model_data)
#summary(model_apm_beds)
tidy_model_apm_beds <- tidy(model_apm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "beds", "na"))

##### CPP and area PM initial model - adding ses_materials

model_apm_ses <- lmer(pulse_pressure_central ~ log_a_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + ses_materials + (1 | house_id), r00_model_data)
#summary(model_apm_ses)
tidy_model_apm_ses <- tidy(model_apm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ses assets", "na"))

##### CPP and area PM initial model - adding phys_act

model_apm_pa <- lmer(pulse_pressure_central ~ log_a_twa + 
                       ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + phys_act + (1 | house_id), r00_model_data)
#summary(model_apm_pa)
tidy_model_apm_pa <- tidy(model_apm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phys act", "na"))

##### CPP and area PM initial model - adding dds_total

model_apm_dds <- lmer(pulse_pressure_central ~ log_a_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + (1 | house_id), r00_model_data)
#summary(model_apm_dds)
tidy_model_apm_dds <- tidy(model_apm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "dds", "na"))

##### CPP and area PM initial model - full model with all potential confounders

model_apm_full <- lmer(pulse_pressure_central ~ log_a_twa + 
                         ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + phys_act +
                        ses_materials + beds_new + 
                        (1 | house_id), r00_model_data)
#summary(model_apm_full)
tidy_model_apm_full <- tidy(model_apm_full, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "full", "na"))



cpp_results <- rbind(tidy_model_apm,
                     tidy_model_apm_no_bp_meds,
                     tidy_model_apm_di_conf,
                     tidy_model_apm_6phases,
                     tidy_model_apm_reduced,
                     tidy_model_apm_phase,
                     tidy_model_apm_season,
                     tidy_model_apm_spline12,
                     tidy_model_apm_bmi,
                     tidy_model_apm_whr,
                     tidy_model_apm_beds,
                     tidy_model_apm_ses,
                     tidy_model_apm_pa,
                     tidy_model_apm_dds,
                     tidy_model_apm_full)
kable(cpp_results)
```

## Plot model estimates - CPP and Area PM
```{r}
plot_estimates <- cpp_results %>%
  mutate(model = factor(model, levels = c("primary", "no bp meds",
                                          "di confdrs", "6 phases", "reduced",
                                          "spline 12 df", "phase", "season",
                                          "bmi", "whr", "beds", "ses assets", "dds",
                                          "phys act", "full"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "CPP Models - Area PM") +
  labs(y = "Estimate (mmHg)") +
  labs(x = "") +
  theme(title = element_text(size = 19), 
          axis.text.x = element_text(angle = 25, hjust = 1, 
                                     size = 18, colour = "black"),
          axis.text.y = element_text(size = 18, colour = "black"),
          axis.title.y = element_text(size = 18),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank()) +
  scale_colour_manual(values=jvPalette) 
plot_estimates
```

# CPP primary model diagnostic plots - Area PM
## Log transforming CPP helps diagnostic plots but doesn't change model results
## Keeping CPP untransformed for ease of interpreting
```{r}
model_apm <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)

plot(model_apm, main = "CPP and area PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_apm), main = "CPP and area PM primary model")

# log(cpp)
model_apm_logcpp <- lmer(log(pulse_pressure_central) ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)

plot(model_apm_logcpp, main = "Log CPP and area PM", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_apm_logcpp), main = "Log CPP and area PM")


#cpp_influential <- influence(model_apm, obs = TRUE)

#cpp_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(cpp_influential, which = "cook")
```

---------------------------------

# CPP and personal PM
```{r}
##### CPP and personal PM phase 1 only 

model_ppm_p1 <- lm(pulse_pressure_central ~ log_p_twa + age_baseline +
                       waist_cm + school_self, r00_model_data_baseline)
#summary(model_ppm_p1)
tidy_model_ppm_p1 <- tidy(model_ppm_p1, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phase 1", "na")) 




##### CPP and personal PM initial model 

model_ppm <- lmer(pulse_pressure_central ~ log_p_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm)
tidy_model_ppm <- tidy(model_ppm, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "primary", "na")) 

##### CPP and personal PM initial model - bp meds removed (57 obs)

model_ppm_no_bp_meds <- lmer(pulse_pressure_central ~ log_p_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_no_bp_meds)
tidy_model_ppm_no_bp_meds <- tidy(model_ppm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "no bp meds", "na")) 

##### CPP and personal PM initial model - dichotomous confounders

model_ppm_di_conf <- lmer(pulse_pressure_central ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_cat +
                      waist_cat + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_di_conf)
tidy_model_ppm_di_conf <- tidy(model_ppm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "di confdrs", "na"))

##### CPP and area PM model - spline with 12 df 

model_ppm_spline12 <- lmer(pulse_pressure_central ~ log_p_twa + 
                    ns(date_sphygmo, df=12) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_spline12)
tidy_model_ppm_spline12 <- tidy(model_ppm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 12 df", "na")) 

##### CPP and personal PM 6 phases model 

model_ppm_6phases <- lmer(pulse_pressure_central ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data_6phases)
#summary(model_ppm_6phases)
tidy_model_ppm_6phases <- tidy(model_ppm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "6 phases", "na")) 

##### CPP and personal PM reduced model 

model_ppm_reduced <- lmer(pulse_pressure_central ~ log_p_twa + 
                            ns(date_sphygmo, df=6) 
                  + (1 | house_id), r00_model_data)
#summary(model_ppm_reduced)
tidy_model_ppm_reduced <- tidy(model_ppm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "reduced", "na")) 

##### CPP and personal PM initial model - phase instead of spline

model_ppm_phase <- lmer(pulse_pressure_central ~ log_p_twa + phase + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_phase)
tidy_model_ppm_phase <- tidy(model_ppm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phase", "na"))

##### CPP and personal PM initial model - season instead of spline

model_ppm_season <- lmer(pulse_pressure_central ~ log_p_twa + season + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_season)
tidy_model_ppm_season <- tidy(model_ppm_season, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "season", "na"))

##### CPP and personal PM initial model - bmi instead of waist_cm

model_ppm_bmi <- lmer(pulse_pressure_central ~ log_p_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_bmi)
tidy_model_ppm_bmi <- tidy(model_ppm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "bmi", "na"))

##### CPP and personal PM initial model - whr instead of waist_cm

model_ppm_whr <- lmer(pulse_pressure_central ~ log_p_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_self + (1 | house_id), r00_model_data)
#summary(model_ppm_whr)
tidy_model_ppm_whr <- tidy(model_ppm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "whr", "na"))

##### CPP and personal PM initial model - adding beds_new

model_ppm_beds <- lmer(pulse_pressure_central ~ log_p_twa + 
                         ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + beds_new + (1 | house_id), r00_model_data)
#summary(model_ppm_beds)
tidy_model_ppm_beds <- tidy(model_ppm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "beds", "na"))

##### CPP and personal PM initial model - adding ses_materials

model_ppm_ses <- lmer(pulse_pressure_central ~ log_p_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + ses_materials + (1 | house_id), r00_model_data)
#summary(model_ppm_ses)
tidy_model_ppm_ses <- tidy(model_ppm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ses assets", "na"))

##### CPP and personal PM initial model - adding phys_act

model_ppm_pa <- lmer(pulse_pressure_central ~ log_p_twa + 
                       ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + phys_act + (1 | house_id), r00_model_data)
#summary(model_ppm_pa)
tidy_model_ppm_pa <- tidy(model_ppm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phys act", "na"))

##### CPP and personal PM initial model - adding dds_total

model_ppm_dds <- lmer(pulse_pressure_central ~ log_p_twa + 
                        ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + (1 | house_id), r00_model_data)
#summary(model_ppm_dds)
tidy_model_ppm_dds <- tidy(model_ppm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "dds", "na"))

##### CPP and personal PM initial model - full model with all potential confounders

model_ppm_full <- lmer(pulse_pressure_central ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + dds_total + phys_act +
                        ses_materials + beds_new + 
                        (1 | house_id), r00_model_data)
#summary(model_ppm_full)
tidy_model_ppm_full <- tidy(model_ppm_full, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "full", "na"))



cpp_results <- rbind(tidy_model_ppm,
                     tidy_model_ppm_no_bp_meds,
                     tidy_model_ppm_di_conf,
                     tidy_model_ppm_6phases,
                     tidy_model_ppm_reduced,
                     tidy_model_ppm_phase,
                     tidy_model_ppm_season,
                     tidy_model_ppm_spline12,
                     tidy_model_ppm_bmi,
                     tidy_model_ppm_whr,
                     tidy_model_ppm_beds,
                     tidy_model_ppm_ses,
                     tidy_model_ppm_pa,
                     tidy_model_ppm_dds,
                     tidy_model_ppm_full)
kable(cpp_results)
```

## Plot model estimates - CPP and Personal PM
```{r}
plot_estimates <- cpp_results %>%
  mutate(model = factor(model, levels = c("primary", "no bp meds",
                                          "di confdrs", "6 phases", "reduced",
                                          "spline 12 df", "phase", "season",
                                          "bmi", "whr", "beds", "ses assets", "dds",
                                          "phys act", "full"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "CPP Models - Personal PM") +
  labs(y = "Estimate (mmHg)") +
  labs(x = "") +
  theme(title = element_text(size = 19), 
          axis.text.x = element_text(angle = 25, hjust = 1, 
                                     size = 18, colour = "black"),
          axis.text.y = element_text(size = 18, colour = "black"),
          axis.title.y = element_text(size = 18),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank()) +
  scale_colour_manual(values=jvPalette) 
plot_estimates
```

# CPP primary model diagnostic plots - Personal PM
## Log transforming CPP helps diagnostic plots but doesn't change model results
## Keeping CPP untransformed for ease of interpreting
```{r}
plot(model_ppm, main = "CPP and personal PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_ppm), main = "CPP and personal PM primary model")


model_ppm_logcpp <- lmer(log(pulse_pressure_central) ~ log_p_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)

plot(model_ppm_logcpp, main = "Log CPP and personal PM", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_ppm_logcpp), main = "Log CPP and personal PM")

#cpp_influential <- influence(model_ppm, obs = TRUE)

#cpp_cooks <- cooks.distance.estex(cpp_influential, sort = TRUE)

#plot.estex(cpp_influential, which = "cook")
```

--------------------

### Spline for PM using gamm4
```{r}
# s() is the command for a spline
# fx=TRUE makes a fixed df regression spline, as opposed to a penalized spline
# bs = "cr" makes this a cubic regression spline
## Default is "tp" for thin plate regression spline
## Both seem to have the same effect on the model
# k = 6 sets the degrees of freedom (df = k-1)
# s() has problems with dates, so using phase in this model instead of spline with date

##### AIx and spline area PM
model_apm_spline <- gamm4(aug_index ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 6) + 
                             age_baseline +  waist_cm + school_self + phase, 
                             data = r00_model_data,
                             random = ~(1 | house_id))
plot(model_apm_spline$gam)
summary(model_apm_spline$gam)
summary(model_apm_spline$mer)


##### AIx and spline personal PM
model_ppm_spline <- gamm4(aug_index ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 6) + 
                             age_baseline +  waist_cm + school_self + phase, 
                             data = r00_model_data,
                             random = ~(1 | house_id))
plot(model_ppm_spline$gam)
summary(model_ppm_spline$gam)
summary(model_ppm_spline$mer)


##### CPP and spline area PM
model_apm_spline <- gamm4(pulse_pressure_central ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 6) + 
                             age_baseline +  waist_cm + school_self + phase, 
                             data = r00_model_data,
                             random = ~(1 | house_id))
plot(model_apm_spline$gam)
summary(model_apm_spline$gam)
summary(model_apm_spline$mer)


##### CPP and spline personal PM
model_ppm_spline <- gamm4(pulse_pressure_central ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 6) + 
                             age_baseline +  waist_cm + school_self + phase, 
                             data = r00_model_data,
                             random = ~(1 | house_id))
plot(model_ppm_spline$gam)
summary(model_ppm_spline$gam)
summary(model_ppm_spline$mer)
```

### Age interaction analysis
```{r}
# AIx and area pm
model_apm_age_int <- lmer(aug_index ~ log_a_twa*age_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_apm_age_int)


# AIx and personal pm
model_ppm_age_int <- lmer(aug_index ~ log_p_twa*age_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_ppm_age_int)


# CPP and area pm
model_apm_age_int <- lmer(pulse_pressure_central ~ log_a_twa*age_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_apm_age_int)


# CPP and personal pm
model_ppm_age_int <- lmer(pulse_pressure_central ~ log_p_twa*age_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_ppm_age_int)
```

### WHR interaction analysis
```{r}
# AIx and area pm
model_apm_whr_int <- lmer(aug_index ~ log_a_twa*whr_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_apm_whr_int)
tidy(model_apm_whr_int, conf.int = TRUE)


# AIx and personal pm
model_ppm_whr_int <- lmer(aug_index ~ log_p_twa*whr_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_ppm_whr_int)


# CPP and area pm
model_apm_whr_int <- lmer(pulse_pressure_central ~ log_a_twa*whr_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_apm_whr_int)


# CPP and personal pm
model_ppm_whr_int <- lmer(pulse_pressure_central ~ log_p_twa*whr_cat + ns(date_sphygmo, df=6) +
                      whr + school_self + (1 | house_id), r00_model_data)
summary(model_ppm_whr_int)
```