---
title: "Honduras R00 PM Models and Plots"
author: "Ethan Walker"
date: "April 2, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
#load full dataset
r00_full_repeated_by_phase <- read_rds("output/r00_full_repeated_by_phase.rds")

# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx (10 total)
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")
```

# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx
```{r}
r00_model_data_outliers_removed <- r00_full_repeated_by_phase %>% 
  # removes 6 potential "outliers" with high or low AIx
  # removes 4 potential "outliers" > 75mmHg CPP
  filter(aug_index < 75 | is.na(aug_index)) %>% 
  filter(aug_index > -25 | is.na(aug_index)) %>% 
  filter(pulse_pressure_central < 75 | is.na(pulse_pressure_central))
write_rds(r00_model_data_outliers_removed, "output/r00_model_data_outliers_removed.rds")
```


```{r}
## Data prep
r00_model_data <- r00_model_data_outliers_removed %>% 
  select(sys_bp_central, dia_bp_central, aug_index, aug_index_75,
         pulse_pressure_periph, pulse_pressure_central, hr, bmi, 
         whr, whr_cat, age_baseline, phase, house_id, season, assigned_stove,
         dds_total, phys_act, school_self, beds_new, ses_materials, 
         a_twa, p_twa) %>% 
  mutate(sys_bp_central = as.numeric(sys_bp_central))%>% 
  mutate(dia_bp_central = as.numeric(dia_bp_central)) %>% 
  mutate(aug_index = as.numeric(aug_index)) %>% 
  mutate(aug_index_75 = as.numeric(aug_index_75)) %>% 
  mutate(pulse_pressure_periph = as.numeric(pulse_pressure_periph))%>% 
  mutate(pulse_pressure_central = as.numeric(pulse_pressure_central)) %>% 
  mutate(hr = as.numeric(hr)) %>% 
  mutate(bmi = as.numeric(bmi)) %>% 
  mutate(whr = as.numeric(whr)) %>% 
  mutate(dds_total = as.numeric(dds_total)) %>% 
  mutate(phys_act = as.numeric(phys_act)) %>% 
  mutate(beds_new = as.numeric(beds_new)) %>% 
  mutate(ses_materials = as.numeric(ses_materials)) %>% 
  mutate(school_self = as.numeric(school_self)) %>%
  mutate(age_baseline = as.numeric(age_baseline)) %>% 
  mutate(phase = as.factor(phase)) %>%
  mutate(house_id = as.factor(house_id)) %>%
  #split age at 40; >40 = 1, <=40 = 0
  mutate(age_cat = if_else(age_baseline >= 40, ">=40", "<40")) %>% 
  mutate(age_cat = as.factor(age_cat)) %>% 
  #split bmi at 26; >26 = 1, <=26 = 0
  mutate(bmi_cat = if_else(bmi >= 26, ">=26", "<26")) %>% 
  mutate(bmi_cat = as.factor(bmi_cat)) %>%
  mutate(season = as.factor(season)) %>%
  mutate(assigned_stove = factor(assigned_stove, levels = c(0, 1), 
                                 labels = c("Traditional", "Justa"))) %>% 
  #standardizing based on IQR
  mutate(a_twa_iqr = as.numeric(a_twa/200)) %>% 
  mutate(p_twa_iqr = as.numeric(p_twa/75))


r00_model_data_6phases <- r00_model_data %>% 
  group_by(house_id) %>% 
  #create new var to be able to filter for participants that completed 6 phases
  mutate(phase_complete = if_else(!is.na(aug_index), 1, 0)) %>% 
  filter(sum(phase_complete) == 6)
```


\pagebreak  

# Primary analyses with a priori confounders
```{r}
## Model Summaries
## Honduras R00 Initial AIx Models
## Base model using season to account for time
## age_baseline + whr + phys_act + dds_total + beds_new + ses_materials + school_self

aix_model_apm <- lmer(aug_index ~ a_twa_iqr + season + age_baseline +
                             whr + phys_act + dds_total + beds_new +
                             ses_materials + school_self +
                             (1 | house_id), r00_model_data)
summary(aix_model_apm)

aix_model_ppm <- lmer(aug_index ~ p_twa_iqr + season + age_baseline +
                             whr + phys_act + dds_total + beds_new +
                             ses_materials + school_self +
                             (1 | house_id), r00_model_data)
summary(aix_model_ppm)


cpp_model_apm <- lmer(pulse_pressure_central ~ a_twa_iqr + season + age_baseline +
                             whr + phys_act + dds_total + beds_new +
                             ses_materials + school_self +
                             (1 | house_id), r00_model_data)
summary(cpp_model_apm)

cpp_model_ppm <- lmer(pulse_pressure_central ~ p_twa_iqr + season + age_baseline +
                             whr + phys_act + dds_total + beds_new +
                             ses_materials + school_self +
                             (1 | house_id), r00_model_data)
summary(cpp_model_ppm)
```

# Potential secondary analyses and interaction
```{r}
sphygmo_model_season_6phases <- lmer(aug_index ~ assigned_stove + season + 
                          (1 | house_id), r00_model_data_6phases)
#  summary(sphygmo_model_6phases)

sphygmo_model_season_outliers <- lmer(aug_index ~ assigned_stove + season + 
                          (1 | house_id), r00_model_data_outliers_aix)
#  summary(sphygmo_model_season_outliers)

sphygmo_model_age <- lmer(aug_index ~ assigned_stove + age_baseline + season + 
                          (1 | house_id), r00_model_data)
#  summary(sphygmo_model_age)

sphygmo_model_age_int <- lmer(aug_index ~ assigned_stove*age_cat + season + 
                          (1 | house_id), r00_model_data_outliers_aix)
#  summary(sphygmo_model_age_int)
age_int_emmeans <- emmeans(sphygmo_model_age_int, pairwise ~ assigned_stove | age_cat)
summary(age_int_emmeans)
plot(age_int_emmeans, comparisons = TRUE, xlab = "means", ylab = "assigned stove") 

sphygmo_model_bmi <- lmer(aug_index ~ assigned_stove + bmi + season + 
                          (1 | house_id), r00_model_data)
#  summary(sphygmo_model_bmi)

sphygmo_model_bmi_int <- lmer(aug_index ~ assigned_stove*bmi_cat + season + 
                          (1 | house_id), r00_model_data_outliers_aix)
#  summary(sphygmo_model_bmi_int)
bmi_int_emmeans <- emmeans(sphygmo_model_bmi_int, pairwise ~ assigned_stove | bmi_cat)
summary(bmi_int_emmeans)
plot(bmi_int_emmeans, comparisons = TRUE, xlab = "means", ylab = "assigned stove")

## save model results
# write_rds(sphygmo_model_spline, "output/aix_model_17nov18.RDS")
```

\pagebreak  

# AIx Model Summaries and Plots
## Using season to account for time
## Analyses with 6 outliers removed: 2 below -25 and 4 above 75
## Keep these outliers out for all future analyses (AIx and CPP)
```{r}
tidy_sphygmo_model_season <- tidy(sphygmo_model_season, conf.int = TRUE) %>% 
    filter(grepl('assigned', term)) %>% 
    rename(ci_low = conf.low, ci_hi = conf.high) %>% 
    mutate(model = if_else(term == "assigned_stoveJusta", "full dataset", "na")) 
tidy_sphygmo_model_season_6phases <- tidy(sphygmo_model_season_6phases, conf.int = TRUE) %>% 
    filter(grepl('assigned', term)) %>% 
    rename(ci_low = conf.low, ci_hi = conf.high) %>% 
    mutate(model = if_else(term == "assigned_stoveJusta", "6 phases", "na")) 
tidy_sphygmo_model_season_outliers <- tidy(sphygmo_model_season_outliers, conf.int = TRUE) %>% 
    filter(grepl('assigned', term)) %>% 
    rename(ci_low = conf.low, ci_hi = conf.high) %>% 
    mutate(model = if_else(term == "assigned_stoveJusta", "6 outliers removed", "na")) 

sphygmo_model_final_results <- rbind(tidy_sphygmo_model_season,
                                     tidy_sphygmo_model_season_6phases,
                                     tidy_sphygmo_model_season_outliers)
kable(sphygmo_model_final_results)


## Plot model estimates with age
plot_estimates <- sphygmo_model_final_results %>%
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  geom_errorbar(aes(x=model, ymin=ci_low, ymax=ci_hi), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "AIx Models", 
          subtitle = "Full dataset vs sensitivity analyses") +
  labs(y = "Estimate (%): Justa vs Traditional") +
  labs(x = "") +
  theme(title = element_text(size = 19), 
          axis.text.x = element_text(angle = 15, hjust = 1, 
                                     size = 18, colour = "black"),
          axis.text.y = element_text(size = 18, colour = "black"),
          axis.title.y = element_text(size = 18),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank()) +
  scale_colour_manual(values=jvPalette) 
plot_estimates
```

\pagebreak  

