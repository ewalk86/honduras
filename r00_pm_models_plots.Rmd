---
title: "Honduras R00 PM Models and Plots"
author: "Ethan Walker"
date: "Updated 7 November 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
library(gamm4)
library(sjstats)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
#load full dataset
# r00_full_repeated_by_phase <- read_rds("output/r00_full_repeated_by_phase.rds")

# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx (10 total)
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")
```

```{r}
r00_model_data <- r00_model_data_outliers_removed %>% 
  # removes 6 observations for participant who wasn't assigned to a study arm
  filter(!is.na(study_arm))
  # Creating variable for time of Sphygmocor assessment to include in the models
  # separate(datetime_sphygmo, c("date_test", "time_test"), sep = " ") %>% 
  # mutate(time_test = hms(time_test))
  # further removes 196 observations (n=1162)
  # filter(!is.na(aug_index)) 

# Dataset for participants who have AIx data for all 6 Phases (107 participants)
r00_data_6phases <- r00_model_data %>%
  filter(complete_case_aix == 1)
  

# Dataset for participants who have AIx data for all <6 Phases
r00_data_5phases <- r00_model_data %>%
  filter(complete_case_aix == 0) 


# Dataset removing 46 participants who missed AIx in phase 2 from sphygmo malfunction
r00_data_sphygmo_p2 <- r00_model_data_outliers_removed %>%
  # removes 6 observations for participant who wasn't assigned to a study arm
  filter(!is.na(study_arm)) %>% 
  mutate(sphygmo_missing_phase2 = as.numeric(sys_bp_final_nurse),
         sphygmo_missing_phase2 = if_else(sphygmo_missing_phase2 > 1, 1, 0),
         sphygmo_missing_phase2 = if_else(is.na(sphygmo_missing_phase2),
                                          0, sphygmo_missing_phase2)) %>%
  group_by(house_id) %>%
  filter(sum(sphygmo_missing_phase2) == 0) %>% 
  ungroup() %>% 
  filter(!is.na(aug_index))  # 949 obs from 184 participants  


# Filtering out medication users (n=34 obs)
r00_model_data_meds <- r00_model_data %>% 
  #filtering out bp med users
  filter(is.na(med_bp)) 
```


# AIx and CPP exposure-response models
```{r}
# Analyses with a priori confounders
## use log transformed pm
## use splines initially, but try phase and season
## age_baseline and school_bi have strong associations with outcomes 
### use in primary model
## waist, whr, and bmi have similar assocations with outcomes
### start with waist but try bmi and whr
## beds_new and ses_materials have weaker associations with outcomes
### add them to model one at a time and see if they make a difference
## phys_act and dds_total have weaker associations with outcomes
### add them to model one at a time and see if they make a difference

##### AIx and area PM all data
# run and save model
model_apm <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline + 
                      waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm)
# format model output for plotting
tidy_model_apm <- tidy(model_apm, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "all data, primary", "na")) 

############################################################
##### AIx and area PM complete case
model_apm_6phases <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_6phases)
#summary(model_apm_6phases)
tidy_model_apm_6phases <- tidy(model_apm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "complete case", "na")) 

############################################################
##### AIx and area PM missed visit
model_apm_5phases <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_5phases)
#summary(model_apm_5phases)
tidy_model_apm_5phases <- tidy(model_apm_5phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "missed visit", "na")) 

############################################################
##### AIx and area PM - participants who missed visit 2 - sphygmo malfunction filtered out
model_p2_sphygmo <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) +
                           age_baseline + waist_cm + school_bi +
                      (1 | house_id), r00_data_sphygmo_p2)
# summary(model_p2_sphygmo)
tidy_model_p2_sphygmo <- tidy(model_p2_sphygmo, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "missed visit 2", "na")) 

############################################################
##### AIx and area PM initial model - bp meds removed (57 obs)
model_apm_no_bp_meds <- lmer(aug_index ~ log_a_twa + 
                             ns(date_sphygmo, df=6) + age_baseline +
                             waist_cm + school_bi + (1 | house_id), 
                             r00_model_data_meds)
#summary(model_apm_no_bp_meds)
tidy_model_apm_no_bp_meds <- tidy(model_apm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "no bp meds", "na")) 

############################################################
##### AIx and area PM initial model - dichotomous confounders
model_apm_di_conf <- lmer(aug_index ~ log_a_twa + 
                          ns(date_sphygmo, df=6) + age_cat_40 +
                          waist_cat + school_bi + (1 | house_id), 
                          r00_model_data)
#summary(model_apm_di_conf)
tidy_model_apm_di_conf <- tidy(model_apm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "di confdrs", "na"))

############################################################
##### AIx and area PM initial model - date spline with 12 df
model_apm_spline12 <- lmer(aug_index ~ log_a_twa + 
                           ns(date_sphygmo, df=12) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_apm_spline12)
tidy_model_apm_spline12 <- tidy(model_apm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 12 df", "na")) 

############################################################
##### AIx and area PM initial model - date spline with 3 df
model_apm_spline3 <- lmer(aug_index ~ log_a_twa + 
                           ns(date_sphygmo, df=3) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_apm_spline3)
tidy_model_apm_spline3 <- tidy(model_apm_spline3, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 3 df", "na")) 

############################################################
##### AIx and area PM reduced model 
model_apm_reduced <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) +
                         (1 | house_id), r00_model_data)
#summary(model_apm_reduced)
tidy_model_apm_reduced <- tidy(model_apm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "reduced", "na")) 

############################################################
##### AIx and area PM initial model - visit instead of spline
model_apm_phase <- lmer(aug_index ~ log_a_twa + phase + age_baseline +
                        waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_phase)
tidy_model_apm_phase <- tidy(model_apm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "visit", "na"))

############################################################
##### AIx and area PM initial model - season instead of spline
model_apm_season <- lmer(aug_index ~ log_a_twa + season + age_baseline +
                         waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_season)
tidy_model_apm_season <- tidy(model_apm_season, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "season", "na"))

############################################################
##### AIx and area PM initial model - bmi instead of waist_cm
model_apm_bmi <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_bmi)
tidy_model_apm_bmi <- tidy(model_apm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "bmi", "na"))

############################################################
##### AIx and area PM initial model - whr instead of waist_cm
model_apm_whr <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_whr)
tidy_model_apm_whr <- tidy(model_apm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "whr", "na"))

############################################################
##### AIx and area PM initial model - adding beds_new
model_apm_beds <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                       waist_cm + school_bi + beds_new + (1 | house_id), 
                       r00_model_data)
#summary(model_apm_beds)
tidy_model_apm_beds <- tidy(model_apm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "beds", "na"))

############################################################
##### AIx and area PM initial model - adding ses_materials
model_apm_ses <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + ses_materials + (1 | house_id),
                      r00_model_data)
#summary(model_apm_ses)
tidy_model_apm_ses <- tidy(model_apm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ses assets", "na"))

############################################################
##### AIx and area PM initial model - adding phys_act
model_apm_pa <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                     waist_cm + school_bi + phys_act + (1 | house_id), 
                     r00_model_data)
#summary(model_apm_pa)
tidy_model_apm_pa <- tidy(model_apm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phys act", "na"))

############################################################
##### AIx and area PM initial model - adding dds_total
model_apm_dds <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + dds_total + (1 | house_id), 
                      r00_model_data)
#summary(model_apm_dds)
tidy_model_apm_dds <- tidy(model_apm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "dds", "na"))

############################################################
##### AIx and area PM initial model - full model with all potential confounders
model_apm_confounders <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + 
                     age_baseline + waist_cat + school_bi +
                     bmi + SES_weighted_sum + whr_cat + phys_act + salt_cat + sugar_cat +
                     (1 | house_id), r00_model_data)
#summary(model_apm_confounders)
tidy_model_apm_confounders <- tidy(model_apm_confounders, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "confounders", "na"))

############################################################
##### AIx and area PM - model with potential ambient confounders
# Try: temp_c, temp_rolling_24, temp_max_previous, temp_max, kitchen_temp,
# ambient_pm, ambient_bc, ambient_oc
model_apm_ambient <- lmer(aug_index ~ log_a_twa + ns(date_sphygmo, df=6) + 
                      age_baseline + waist_cat + school_bi +
                      temp_c + 
                      (1 | house_id), r00_model_data)
#summary(model_apm_ambient)
tidy_model_apm_ambient <- tidy(model_apm_ambient, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ambient", "na"))

############################################################
# Combine formatted results for plotting
aix_results <- rbind(tidy_model_apm,
                     tidy_model_apm_6phases,
                     tidy_model_apm_5phases,
                     tidy_model_p2_sphygmo,
                     tidy_model_apm_no_bp_meds,
                     tidy_model_apm_spline12,
                     tidy_model_apm_spline3,
                     tidy_model_apm_ambient,
                     tidy_model_apm_confounders)
#kable(aix_results)
```


```{r}
## Plot model estimates - AIx and Area PM

plot_estimates <- aix_results %>%
  mutate(model = factor(model, levels = c("all data, primary", "complete case", 
                                          "missed visit", "missed visit 2",
                                          "no bp meds", "spline 12 df", "spline 3 df",
                                          "ambient", "confounders"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  #scale_shape_manual(values = c(15, 16, 17, 18, 13, 9, 4, 8, 14, 10, 12, 7, 11)) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  #ggtitle(label = "AIx area PM model") +
  labs(y = "Estimate per natural log increase \n in fine particulate matter (%)") +
  labs(x = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 25,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "none") +
  scale_y_continuous(breaks = c(-1, -.75, -.5, -.25, 0, .25, .5, .75, 1), 
                     labels = c(-1, -.75, -.5, -.25, 0, .25, .5, .75, 1)) 
plot_estimates
```


```{r}
# AIx primary model diagnostic plots - Area PM

plot(model_apm, main = "AIx and area PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_apm), main = "AIx and area PM primary model")


#aix_influential <- influence(model_apm, obs = TRUE)

#aix_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(aix_influential, which = "cook")
```

---------------------------------


```{r}
# AIx and personal PM

##### AIx and personal PM all data
model_ppm <- lmer(aug_index ~ log_p_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm)
tidy_model_ppm <- tidy(model_ppm, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "all data, primary", "na")) 

############################################################
##### AIx and personal PM complete case
model_ppm_6phases <- lmer(aug_index ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_6phases)
#summary(model_ppm_6phases)
tidy_model_ppm_6phases <- tidy(model_ppm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "complete case", "na")) 

############################################################
##### AIx and personal PM missed phase
model_ppm_5phases <- lmer(aug_index ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_5phases)
#summary(model_ppm_5phases)
tidy_model_ppm_5phases <- tidy(model_ppm_5phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "missed visit", "na"))

############################################################
##### AIx and personal PM - participants who missed phase 2 - sphygmo malfunction filtered out
model_p2_sphygmo <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) +
                           age_baseline + waist_cm + school_bi +
                      (1 | house_id), r00_data_sphygmo_p2)
# summary(model_p2_sphygmo)
tidy_model_p2_sphygmo <- tidy(model_p2_sphygmo, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "missed visit 2", "na")) 

############################################################
##### AIx and personal PM initial model - bp meds removed (57 obs)
model_ppm_no_bp_meds <- lmer(aug_index ~ log_p_twa + 
                             ns(date_sphygmo, df=6) + age_baseline +
                             waist_cm + school_bi + (1 | house_id), 
                             r00_model_data_meds)
#summary(model_ppm_no_bp_meds)
tidy_model_ppm_no_bp_meds <- tidy(model_ppm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "no bp meds", "na")) 

############################################################
##### AIx and personal PM initial model - dichotomous confounders
model_ppm_di_conf <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_cat_40 +
                          waist_cat + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_di_conf)
tidy_model_ppm_di_conf <- tidy(model_ppm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "di confdrs", "na"))

############################################################
##### AIx and personal PM initial model - spline with 12 df
model_ppm_spline12 <- lmer(aug_index ~ log_p_twa + 
                           ns(date_sphygmo, df=12) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_ppm_spline12)
tidy_model_ppm_spline12 <- tidy(model_ppm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 12 df", "na")) 

############################################################
##### AIx and personal PM initial model - spline with 3 df
model_ppm_spline3 <- lmer(aug_index ~ log_p_twa + 
                           ns(date_sphygmo, df=3) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_ppm_spline3)
tidy_model_ppm_spline3 <- tidy(model_ppm_spline3, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 3 df", "na")) 

############################################################
##### AIx and personal PM reduced model 
model_ppm_reduced <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) +
                         (1 | house_id), r00_model_data)
#summary(model_ppm_reduced)
tidy_model_ppm_reduced <- tidy(model_ppm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "reduced", "na")) 

############################################################
##### AIx and personal PM initial model - phase instead of spline
model_ppm_phase <- lmer(aug_index ~ log_p_twa + phase + age_baseline +
                        waist_cm + school_bi + (1 | house_id), 
                        r00_model_data)
#summary(model_ppm_phase)
tidy_model_ppm_phase <- tidy(model_ppm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "visit", "na"))

############################################################
##### AIx and personal PM initial model - season instead of spline
model_ppm_season <- lmer(aug_index ~ log_p_twa + season + age_baseline +
                         waist_cm + school_bi + (1 | house_id), 
                         r00_model_data)
#summary(model_ppm_season)
tidy_model_ppm_season <- tidy(model_ppm_season, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "season", "na"))

############################################################
##### AIx and personal PM initial model - bmi instead of waist_cm
model_ppm_bmi <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_bmi)
tidy_model_ppm_bmi <- tidy(model_ppm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "bmi", "na"))

############################################################
##### AIx and personal PM initial model - whr instead of waist_cm
model_ppm_whr <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_whr)
tidy_model_ppm_whr <- tidy(model_ppm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "whr", "na"))

############################################################
##### AIx and personal PM initial model - adding beds_new
model_ppm_beds <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                       waist_cm + school_bi + beds_new + (1 | house_id), 
                       r00_model_data)
#summary(model_ppm_beds)
tidy_model_ppm_beds <- tidy(model_ppm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "beds", "na"))

############################################################
##### AIx and personal PM initial model - adding ses_materials
model_ppm_ses <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + ses_materials + (1 | house_id), 
                      r00_model_data)
#summary(model_ppm_ses)
tidy_model_ppm_ses <- tidy(model_ppm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ses assets", "na"))

############################################################
##### AIx and personal PM initial model - adding phys_act
model_ppm_pa <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                     waist_cm + school_bi + phys_act + (1 | house_id), 
                     r00_model_data)
#summary(model_ppm_pa)
tidy_model_ppm_pa <- tidy(model_ppm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phys act", "na"))

############################################################
##### AIx and personal PM initial model - adding dds_total
model_ppm_dds <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + dds_total + (1 | house_id), 
                      r00_model_data)
#summary(model_ppm_dds)
tidy_model_ppm_dds <- tidy(model_ppm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "dds", "na"))

############################################################
##### AIx and personal PM initial model - full model with all potential confounders
model_ppm_confounders <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + 
                     age_baseline + waist_cat + school_bi +
                     bmi + SES_weighted_sum + whr_cat + phys_act + salt_cat + sugar_cat +
                     (1 | house_id), r00_model_data)
#summary(model_ppm_confounders)
tidy_model_ppm_confounders <- tidy(model_ppm_confounders, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "confounders", "na"))

############################################################
##### AIx and personal PM - model with potential ambient confounders
# Try: temp_c, temp_rolling_24, temp_max_previous, temp_max, kitchen_temp,
# ambient_pm, ambient_bc, ambient_oc
model_ppm_ambient <- lmer(aug_index ~ log_p_twa + ns(date_sphygmo, df=6) + 
                      age_baseline + waist_cat + school_bi +
                      temp_c + 
                      (1 | house_id), r00_model_data)
#summary(model_ppm_ambient)
tidy_model_ppm_ambient <- tidy(model_ppm_ambient, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ambient", "na"))

############################################################
aix_results <- rbind(tidy_model_ppm,
                     tidy_model_ppm_6phases,
                     tidy_model_ppm_5phases,
                     tidy_model_p2_sphygmo,
                     tidy_model_ppm_no_bp_meds,
                     tidy_model_ppm_spline12,
                     tidy_model_ppm_spline3,
                     tidy_model_ppm_ambient,
                     tidy_model_ppm_confounders)
#kable(aix_results)
```


```{r}
## Plot model estimates - AIx and Personal PM

plot_estimates <- aix_results %>%
  mutate(model = factor(model, levels = c("all data, primary", "complete case", 
                                          "missed visit", "missed visit 2",
                                          "no bp meds", "spline 12 df", "spline 3 df",
                                          "ambient", "confounders"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  #scale_shape_manual(values = c(15, 16, 17, 18, 13, 9, 4, 8, 14, 10, 12, 7, 11)) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  #ggtitle(label = "AIx personal PM model") +
  labs(y = "Estimate per natural log increase \n in fine particulate matter (%)") +
  labs(x = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 25,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "none") +
  scale_y_continuous(breaks = c(-1, -.75, -.5, -.25, 0, .25, .5, .75, 1), 
                     labels = c(-1, -.75, -.5, -.25, 0, .25, .5, .75, 1)) 
plot_estimates
```


```{r}
# AIx primary model diagnostic plots - Personal PM

plot(model_ppm, main = "AIx and personal PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_ppm), main = "AIx and personal PM primary model")


#aix_influential <- influence(model_ppm, obs = TRUE)

#aix_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(aix_influential, which = "cook")
```

---------------------------------


```{r}
# CPP and area PM

##### CPP and area PM all data
model_apm <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm)
tidy_model_apm <- tidy(model_apm, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "all data, primary", "na")) 

############################################################
##### CPP and area PM complete case
model_apm_6phases <- lmer(pulse_pressure_central ~ log_a_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_6phases)
#summary(model_apm_6phases)
tidy_model_apm_6phases <- tidy(model_apm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "complete case", "na")) 

############################################################
##### CPP and area PM missed phase
model_apm_5phases <- lmer(pulse_pressure_central ~ log_a_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_5phases)
#summary(model_apm_5phases)
tidy_model_apm_5phases <- tidy(model_apm_5phases, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "missed visit", "na")) 

############################################################
##### CPP and area PM - participants who missed phase 2 - sphygmo malfunction filtered out
model_p2_sphygmo <- lmer(pulse_pressure_central ~ log_a_twa + ns(date_sphygmo, df=6) +
                         age_baseline + waist_cm + school_bi +
                      (1 | house_id), r00_data_sphygmo_p2)
# summary(model_p2_sphygmo)
tidy_model_p2_sphygmo <- tidy(model_p2_sphygmo, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "missed visit 2", "na")) 

############################################################
##### CPP and area PM initial model - bp meds removed (57 obs)
model_apm_no_bp_meds <- lmer(pulse_pressure_central ~ log_a_twa + 
                             ns(date_sphygmo, df=6) + age_baseline +
                             waist_cm + school_bi + (1 | house_id), 
                             r00_model_data_meds)
#summary(model_apm_no_bp_meds)
tidy_model_apm_no_bp_meds <- tidy(model_apm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "no bp meds", "na")) 

############################################################
##### CPP and area PM initial model - dichotomous confounders
model_apm_di_conf <- lmer(pulse_pressure_central ~ log_a_twa + 
                          ns(date_sphygmo, df=6) + age_cat_40 +
                          waist_cat + school_bi + (1 | house_id), 
                          r00_model_data)
#summary(model_apm_di_conf)
tidy_model_apm_di_conf <- tidy(model_apm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "di confdrs", "na"))

############################################################
##### CPP and area PM model - spline with 12 df 
model_apm_spline12 <- lmer(pulse_pressure_central ~ log_a_twa + 
                           ns(date_sphygmo, df=12) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_apm_spline12)
tidy_model_apm_spline12 <- tidy(model_apm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 12 df", "na")) 

############################################################
##### CPP and area PM model - spline with 3 df 
model_apm_spline3 <- lmer(pulse_pressure_central ~ log_a_twa + 
                           ns(date_sphygmo, df=3) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_apm_spline3)
tidy_model_apm_spline3 <- tidy(model_apm_spline3, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "spline 3 df", "na")) 

############################################################
##### CPP and area PM reduced model 
model_apm_reduced <- lmer(pulse_pressure_central ~ log_a_twa + 
                          ns(date_sphygmo, df=6) + (1 | house_id), 
                          r00_model_data)
#summary(model_apm_reduced)
tidy_model_apm_reduced <- tidy(model_apm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "reduced", "na")) 

############################################################
##### CPP and area PM initial model - phase instead of spline
model_apm_phase <- lmer(pulse_pressure_central ~ log_a_twa + phase + age_baseline +
                        waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_phase)
tidy_model_apm_phase <- tidy(model_apm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "visit", "na"))

############################################################
##### CPP and area PM initial model - season instead of spline
model_apm_season <- lmer(pulse_pressure_central ~ log_a_twa + season + age_baseline +
                         waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_season)
tidy_model_apm_season <- tidy(model_apm_season, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "season", "na"))

############################################################
##### CPP and area PM initial model - bmi instead of waist_cm
model_apm_bmi <- lmer(pulse_pressure_central ~ log_a_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_bmi)
tidy_model_apm_bmi <- tidy(model_apm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "bmi", "na"))

############################################################
##### CPP and area PM initial model - whr instead of waist_cm
model_apm_whr <- lmer(pulse_pressure_central ~ log_a_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_bi + (1 | house_id), r00_model_data)
#summary(model_apm_whr)
tidy_model_apm_whr <- tidy(model_apm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "whr", "na"))

############################################################
##### CPP and area PM initial model - adding beds_new
model_apm_beds <- lmer(pulse_pressure_central ~ log_a_twa + 
                       ns(date_sphygmo, df=6) + age_baseline +
                       waist_cm + school_bi + beds_new + 
                       (1 | house_id), r00_model_data)
#summary(model_apm_beds)
tidy_model_apm_beds <- tidy(model_apm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "beds", "na"))

############################################################
##### CPP and area PM initial model - adding ses_materials
model_apm_ses <- lmer(pulse_pressure_central ~ log_a_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + ses_materials + 
                      (1 | house_id), r00_model_data)
#summary(model_apm_ses)
tidy_model_apm_ses <- tidy(model_apm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ses assets", "na"))

############################################################
##### CPP and area PM initial model - adding phys_act
model_apm_pa <- lmer(pulse_pressure_central ~ log_a_twa + 
                     ns(date_sphygmo, df=6) + age_baseline +
                     waist_cm + school_bi + phys_act + 
                     (1 | house_id), r00_model_data)
#summary(model_apm_pa)
tidy_model_apm_pa <- tidy(model_apm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "phys act", "na"))

############################################################
##### CPP and area PM initial model - adding dds_total
model_apm_dds <- lmer(pulse_pressure_central ~ log_a_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + dds_total + 
                      (1 | house_id), r00_model_data)
#summary(model_apm_dds)
tidy_model_apm_dds <- tidy(model_apm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "dds", "na"))

############################################################
##### CPP and area PM initial model - full model with all potential confounders
model_apm_confounders <- lmer(pulse_pressure_central ~ log_a_twa + 
                     ns(date_sphygmo, df=6) + age_baseline + waist_cat + school_bi +
                     bmi + SES_weighted_sum + whr_cat + phys_act + 
                     (1 | house_id), r00_model_data)
#summary(model_apm_confounders)
tidy_model_apm_confounders <- tidy(model_apm_confounders, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "confounders", "na"))

############################################################
##### CPP and area PM - model with potential ambient confounders
# Try: temp_c, temp_rolling_24, temp_max_previous, temp_max, kitchen_temp,
# ambient_pm, ambient_bc, ambient_oc
model_apm_ambient <- lmer(pulse_pressure_central ~ log_a_twa + ns(date_sphygmo, df=6) + 
                   age_baseline + waist_cm + school_bi +  
                   temp_c + 
                   (1 | house_id), r00_model_data)
#summary(model_apm_ambient)
tidy_model_apm_ambient <- tidy(model_apm_ambient, conf.int = TRUE) %>% 
    filter(grepl('log_a_twa', term)) %>% 
    mutate(model = if_else(term == "log_a_twa", "ambient", "na"))


############################################################
cpp_results <- rbind(tidy_model_apm,
                     tidy_model_apm_6phases,
                     tidy_model_apm_5phases,
                     tidy_model_p2_sphygmo,
                     tidy_model_apm_no_bp_meds,
                     tidy_model_apm_spline12,
                     tidy_model_apm_spline3,
                     tidy_model_apm_confounders,
                     tidy_model_apm_ambient)
#kable(cpp_results)
```


```{r}
## Plot model estimates - CPP and Area PM

plot_estimates <- cpp_results %>%
  mutate(model = factor(model, levels = c("all data, primary", "complete case", "missed visit", 
                                          "missed visit 2",
                                          "no bp meds", "spline 12 df", "spline 3 df",
                                          "ambient", "confounders"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  #scale_shape_manual(values = c(15, 16, 17, 18, 13, 9, 4, 8, 14, 10, 12, 7, 11)) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  #ggtitle(label = "CPP area PM model") +
  labs(y = "Estimate per natural log increase \n in fine particulate matter (mmHg)") +
  labs(x = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 25,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "none") +
  scale_y_continuous(breaks = c(-.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8), 
                     labels = c(-.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8)) 
plot_estimates
```

# CPP primary model diagnostic plots - Area PM
## Log transforming CPP helps diagnostic plots but doesn't change model results
## Keeping CPP untransformed for ease of interpreting
```{r}
model_apm <- lmer(pulse_pressure_central ~ log_a_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_self + (1 | house_id), r00_model_data)

plot(model_apm, main = "CPP and area PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_apm), main = "CPP and area PM primary model")


#cpp_influential <- influence(model_apm, obs = TRUE)

#cpp_cooks <- cooks.distance.estex(aix_influential, sort = TRUE)

#plot.estex(cpp_influential, which = "cook")
```

---------------------------------


```{r}
# CPP and personal PM

##### CPP and personal PM all data
model_ppm <- lmer(pulse_pressure_central ~ log_p_twa + 
                    ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm)
tidy_model_ppm <- tidy(model_ppm, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "all data, primary", "na")) 

############################################################
##### CPP and personal PM complete case
model_ppm_6phases <- lmer(pulse_pressure_central ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_6phases)
#summary(model_ppm_6phases)
tidy_model_ppm_6phases <- tidy(model_ppm_6phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "complete case", "na")) 

############################################################
##### CPP and personal PM missed phase
model_ppm_5phases <- lmer(pulse_pressure_central ~ log_p_twa + 
                            ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + (1 | house_id), r00_data_5phases)
#summary(model_ppm_5phases)
tidy_model_ppm_5phases <- tidy(model_ppm_5phases, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "missed visit", "na")) 

############################################################
##### CPP and personal PM - participants who missed phase 2 - sphygmo malfunction filtered out
model_p2_sphygmo <- lmer(pulse_pressure_central ~ log_p_twa + ns(date_sphygmo, df=6) +
                         age_baseline + waist_cm + school_bi +
                      (1 | house_id), r00_data_sphygmo_p2)
# summary(model_p2_sphygmo)
tidy_model_p2_sphygmo <- tidy(model_p2_sphygmo, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "missed visit 2", "na")) 

############################################################
##### CPP and personal PM initial model - bp meds removed (57 obs)
model_ppm_no_bp_meds <- lmer(pulse_pressure_central ~ log_p_twa + 
                             ns(date_sphygmo, df=6) + age_baseline +
                             waist_cm + school_bi + (1 | house_id), 
                             r00_model_data_meds)
#summary(model_ppm_no_bp_meds)
tidy_model_ppm_no_bp_meds <- tidy(model_ppm_no_bp_meds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "no bp meds", "na")) 

############################################################
##### CPP and personal PM initial model - dichotomous confounders
model_ppm_di_conf <- lmer(pulse_pressure_central ~ log_p_twa + 
                          ns(date_sphygmo, df=6) + age_cat_40 +
                          waist_cat + school_bi + (1 | house_id), 
                          r00_model_data)
#summary(model_ppm_di_conf)
tidy_model_ppm_di_conf <- tidy(model_ppm_di_conf, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "di confdrs", "na"))

############################################################
##### CPP and area PM model - spline with 12 df 
model_ppm_spline12 <- lmer(pulse_pressure_central ~ log_p_twa + 
                           ns(date_sphygmo, df=12) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_ppm_spline12)
tidy_model_ppm_spline12 <- tidy(model_ppm_spline12, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 12 df", "na")) 

############################################################
##### CPP and area PM model - spline with 3 df 
model_ppm_spline3 <- lmer(pulse_pressure_central ~ log_p_twa + 
                           ns(date_sphygmo, df=3) + age_baseline +
                           waist_cm + school_bi + (1 | house_id), 
                           r00_model_data)
#summary(model_ppm_spline3)
tidy_model_ppm_spline3 <- tidy(model_ppm_spline3, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "spline 3 df", "na")) 

############################################################
##### CPP and personal PM reduced model 
model_ppm_reduced <- lmer(pulse_pressure_central ~ log_p_twa + 
                          ns(date_sphygmo, df=6) +
                          (1 | house_id), r00_model_data)
#summary(model_ppm_reduced)
tidy_model_ppm_reduced <- tidy(model_ppm_reduced, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "reduced", "na")) 

############################################################
##### CPP and personal PM initial model - phase instead of spline
model_ppm_phase <- lmer(pulse_pressure_central ~ log_p_twa + phase + age_baseline +
                        waist_cm + school_bi + (1 | house_id), 
                        r00_model_data)
#summary(model_ppm_phase)
tidy_model_ppm_phase <- tidy(model_ppm_phase, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "visit", "na"))

############################################################
##### CPP and personal PM initial model - season instead of spline
model_ppm_season <- lmer(pulse_pressure_central ~ log_p_twa + season + age_baseline +
                         waist_cm + school_bi + (1 | house_id), 
                         r00_model_data)
#summary(model_ppm_season)
tidy_model_ppm_season <- tidy(model_ppm_season, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "season", "na"))

############################################################
##### CPP and personal PM initial model - bmi instead of waist_cm
model_ppm_bmi <- lmer(pulse_pressure_central ~ log_p_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      bmi + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_bmi)
tidy_model_ppm_bmi <- tidy(model_ppm_bmi, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "bmi", "na"))

############################################################
##### CPP and personal PM initial model - whr instead of waist_cm
model_ppm_whr <- lmer(pulse_pressure_central ~ log_p_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      whr + school_bi + (1 | house_id), r00_model_data)
#summary(model_ppm_whr)
tidy_model_ppm_whr <- tidy(model_ppm_whr, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "whr", "na"))

############################################################
##### CPP and personal PM initial model - adding beds_new
model_ppm_beds <- lmer(pulse_pressure_central ~ log_p_twa + 
                       ns(date_sphygmo, df=6) + age_baseline +
                       waist_cm + school_bi + beds_new + 
                       (1 | house_id), r00_model_data)
#summary(model_ppm_beds)
tidy_model_ppm_beds <- tidy(model_ppm_beds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "beds", "na"))

############################################################
##### CPP and personal PM initial model - adding ses_materials
model_ppm_ses <- lmer(pulse_pressure_central ~ log_p_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + ses_materials + 
                      (1 | house_id), r00_model_data)
#summary(model_ppm_ses)
tidy_model_ppm_ses <- tidy(model_ppm_ses, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ses assets", "na"))

############################################################
##### CPP and personal PM initial model - adding phys_act
model_ppm_pa <- lmer(pulse_pressure_central ~ log_p_twa + 
                     ns(date_sphygmo, df=6) + age_baseline +
                     waist_cm + school_bi + phys_act + (1 | house_id), 
                     r00_model_data)
#summary(model_ppm_pa)
tidy_model_ppm_pa <- tidy(model_ppm_pa, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "phys act", "na"))

############################################################
##### CPP and personal PM initial model - adding dds_total
model_ppm_dds <- lmer(pulse_pressure_central ~ log_p_twa + 
                      ns(date_sphygmo, df=6) + age_baseline +
                      waist_cm + school_bi + dds_total + 
                      (1 | house_id), r00_model_data)
#summary(model_ppm_dds)
tidy_model_ppm_dds <- tidy(model_ppm_dds, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "dds", "na"))

############################################################
##### CPP and personal PM initial model - full model with all potential confounders
model_ppm_confounders <- lmer(pulse_pressure_central ~ log_p_twa + 
                     ns(date_sphygmo, df=6) + age_baseline + waist_cat + school_bi +
                     bmi + SES_weighted_sum + whr_cat + phys_act + 
                     (1 | house_id), r00_model_data)
#summary(model_ppm_confounders)
tidy_model_ppm_confounders <- tidy(model_ppm_confounders, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "confounders", "na"))

############################################################
##### CPP and personal PM - model with potential ambient confounders
# Try: temp_c, temp_rolling_24, temp_max_previous, temp_max, kitchen_temp,
# ambient_pm, ambient_bc, ambient_oc
model_ppm_ambient <- lmer(pulse_pressure_central ~ log_p_twa 
                       + ns(date_sphygmo, df=6) + 
                   age_baseline + waist_cm + school_bi +  
                   temp_c + 
                   (1 | house_id), r00_model_data)
#summary(model_ppm_ambient)
tidy_model_ppm_ambient <- tidy(model_ppm_ambient, conf.int = TRUE) %>% 
    filter(grepl('log_p_twa', term)) %>% 
    mutate(model = if_else(term == "log_p_twa", "ambient", "na"))


############################################################
cpp_results <- rbind(tidy_model_ppm,
                     tidy_model_ppm_6phases,
                     tidy_model_ppm_5phases,
                     tidy_model_p2_sphygmo,
                     tidy_model_ppm_no_bp_meds,
                     tidy_model_ppm_spline12,
                     tidy_model_ppm_spline3,
                     tidy_model_ppm_confounders,
                     tidy_model_ppm_ambient)
#kable(cpp_results)
```


```{r}
## Plot model estimates - CPP and Personal PM

plot_estimates <- cpp_results %>%
  mutate(model = factor(model, levels = c("all data, primary", "complete case", 
                                          "missed visit", "missed visit 2",
                                          "no bp meds", "spline 12 df", "spline 3 df",
                                          "ambient", "confounders"))) %>% 
  ggplot() +
  geom_point(aes(x=model, y=estimate), size = 4) +
  #scale_shape_manual(values = c(15, 16, 17, 18, 13, 9, 4, 8, 14, 10, 12, 7, 11)) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
                size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  #ggtitle(label = "CPP personal PM model") +
  labs(y = "Estimate per natural log increase \n in fine particulate matter (mmHg)") +
  labs(x = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 25,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "none") +
  scale_y_continuous(breaks = c(-.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8), 
                     labels = c(-.5, -.4, -.3, -.2, -.1, 0, .1, .2, .3, .4, .5, .6, .7, .8)) 
plot_estimates
```

# CPP primary model diagnostic plots - Personal PM
## Log transforming CPP helps diagnostic plots but doesn't change model results
## Keeping CPP untransformed for ease of interpreting
```{r}
plot(model_ppm, main = "CPP and personal PM primary model", 
     xlab = "fitted values", ylab = "residuals")

qqnorm(residuals(model_ppm), main = "CPP and personal PM primary model")



#cpp_influential <- influence(model_ppm, obs = TRUE)

#cpp_cooks <- cooks.distance.estex(cpp_influential, sort = TRUE)

#plot.estex(cpp_influential, which = "cook")
```

