---
title: "R00 Analysis - PM Using Splines"
author: "Ethan Walker"
date: "May 9, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 5)
```


```{r, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
library(gamm4)
library(sjstats)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
# USE THIS DATASET FOR ANALYSES!!!
## Removes values >75 for AIx and CPP, and <-25 for AIx (10 total)
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")
```

```{r}
## Data prep - primary model dataset
r00_model_data <- r00_model_data_outliers_removed %>% 
  mutate(date_sphygmo = ymd(date_sphygmo),
         date_days = (as.numeric(date_sphygmo)-16667)) %>% 
  filter(!is.na(assigned_stove))

# Dataset for participants who did not miss phase 2
r00_model_data_phase2 <- r00_model_data %>% 
  mutate(phase2 = 1) %>% 
  mutate(phase2 = if_else(phase == 2 & is.na(aug_index), 0, phase2)) %>%  
  group_by(house_id) %>% 
  filter(sum(phase2) == 6) %>% 
  ungroup() 
```


## AIx and spline area PM
```{r, echo=TRUE}
# s() is the command for a spline
# fx=TRUE makes a fixed df regression spline, as opposed to a penalized spline
# bs = "cr" makes this a cubic regression spline
## Default is "tp" for thin plate regression spline
## Both seem to have the same effect on the model
# k = 6 sets the degrees of freedom (df = k-1)
# s() has problems with dates, so using a numeric form for date that counts up 
  # the number of days beginning on the first day of the study

model_apm_spline <- gamm4(aug_index ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 6) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data_phase2,
                          random = ~(1 | house_id))
plot(model_apm_spline$gam, seWithMean = TRUE, select = 1, shade = TRUE,
     xlab = expression(paste("Natural log transformed 24-hour area PM"[2.5], 
                             " (", mu, g/m^3, ")")),
     ylab = expression(paste("Estimate, spline trend for area PM  "[2.5], " (%)")))
summary(model_apm_spline$gam)
summary(model_apm_spline$mer)

model_apm_spline <- gamm4(aug_index ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 4) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data,
                          random = ~(1 | house_id))
plot(model_apm_spline$gam, seWithMean = TRUE)
```

\pagebreak  

## AIx and spline personal PM
```{r}
model_ppm_spline <- gamm4(aug_index ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 6) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data_phase2,
                          random = ~(1 | house_id))
plot(model_ppm_spline$gam, seWithMean = TRUE, select = 1, shade = TRUE,
     xlab = expression(paste("Natural log transformed 24-hour personal PM"[2.5], 
                             " (", mu, g/m^3, ")")),
     ylab = expression(paste("Estimate, spline trend for personal PM  "[2.5], " (%)")))
summary(model_ppm_spline$gam)
summary(model_ppm_spline$mer)

model_ppm_spline <- gamm4(aug_index ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 4) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data,
                          random = ~(1 | house_id))
plot(model_ppm_spline$gam, seWithMean = TRUE)
```

\pagebreak  

## CPP and spline area PM
```{r}
model_apm_spline <- gamm4(pulse_pressure_central ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 6) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data_phase2,
                          random = ~(1 | house_id))
plot(model_apm_spline$gam, seWithMean = TRUE, select = 1, shade = TRUE,
     xlab = expression(paste("Natural log transformed 24-hour area PM"[2.5], 
                             " (", mu, g/m^3, ")")),
     ylab = expression(paste("Estimate, spline trend for area PM  "[2.5], " (mmHg)")))
summary(model_apm_spline$gam)
summary(model_apm_spline$mer)

model_apm_spline <- gamm4(pulse_pressure_central ~ s(log_a_twa, fx = TRUE, bs = "cr", k = 4) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data,
                          random = ~(1 | house_id))
plot(model_apm_spline$gam, seWithMean = TRUE)
```

\pagebreak  

## CPP and spline personal PM
```{r}
model_ppm_spline <- gamm4(pulse_pressure_central ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 6) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data_phase2,
                          random = ~(1 | house_id))
plot(model_ppm_spline$gam, seWithMean = TRUE, select = 1, shade = TRUE,
     xlab = expression(paste("Natural log transformed 24-hour personal PM"[2.5], 
                             " (", mu, g/m^3, ")")),
     ylab = expression(paste("Estimate, spline trend for personal PM  "[2.5], " (mmHg)")))
summary(model_ppm_spline$gam)
summary(model_ppm_spline$mer)

model_ppm_spline <- gamm4(pulse_pressure_central ~ s(log_p_twa, fx = TRUE, bs = "cr", k = 4) + 
                          age_baseline +  waist_cm + school_bi + 
                          s(date_days, fx = TRUE, bs = "cr", k = 7), 
                          data = r00_model_data,
                          random = ~(1 | house_id))
plot(model_ppm_spline$gam, seWithMean = TRUE)
```
