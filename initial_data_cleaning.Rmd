---
title: "Initial Data Cleaning"
author: "Ethan Walker"
date: "6 August 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
```

```{r, message=FALSE}
# Load data
#r00_p6_pre_weights <- read_csv("input/honduras_r00_p6_pre_weights.csv")
#r00_p6_post_weights <- read_csv("input/honduras_r00_p6_post_weights.csv")
#r00_full_wide <- read_xlsx("input/R00_health_wide_06Aug2018_by.xlsx")

r00_p6_weights_combined <- readRDS("output/r00_p6_weights_combined.rds")
r00_p6_pre_weights <- readRDS("output/r00_p6_pre_weights.rds")
r00_p6_post_weights <- readRDS("output/r00_p6_post_weights.rds")

r00_full_wide <- readRDS("output/r00_full_wide.rds")
```

##### Phase 6 initial exposure data check and cleaning #####
```{r}
# rename entry_check vars
r00_p6_pre_weights <- r00_p6_pre_weights %>% 
  rename(entry_check_pre = entry_check)
r00_p6_post_weights <- r00_p6_post_weights %>% 
  rename(entry_check_post = entry_check)

r00_p6_weights_combined <- full_join(r00_p6_pre_weights, r00_p6_post_weights, by = "filter_id")

# save datasets as RDS
saveRDS(r00_p6_weights_combined, "output/r00_p6_weights_combined.rds")
saveRDS(r00_p6_pre_weights, "output/r00_p6_pre_weights.rds")
saveRDS(r00_p6_post_weights, "output/r00_p6_post_weights.rds")
```

```{r}
# Initial data check on weights
weight_check <- r00_p6_weights_combined %>% 
  mutate(pre_post_diff = (average_post - average_pre)) %>% 
  mutate(pre_post_check = if_else(pre_post_diff < 0, "neg", "pos")) 

# P6-338 has no pre-weight -  post-weight entered correctly - P6-238 entered twice
 #### Changed in database ####
# P6-217 has no pre-weight -  post-weight entered correctly - P6-218 entered twice
 #### Changed in database ####
# P6-162 has no pre-weight -  post-weight entered correctly - P6-126 entered twice
 #### Changed in database ####
# P6-498 entered twice 
 #### The one with pre-weight of 109.801 (higher than post-weight) was renamed to P6-468 (missing from pre-weights) ####

# P6-247 entered correctly - reweigh
# P6-339 entered correctly - reweigh
# P6-405 entered correctly - reweigh
# P6-078 entered correctly - reweigh - "dropped prior to weighing (pre)"
# P6-442 entered correctly - reweigh
# P6-074 entered correctly - reweigh - pre trip colocation
# P6-475 entered correctly - reweigh
# P6-395 entered correctly - less than 0.01 difference, don't reweigh
# P6-328 entered correctly - less than 0.01 difference, don't reweigh
# P6-424 entered correctly - less than 0.01 difference, don't reweigh
# P6-176 entered correctly - less than 0.01 difference, don't reweigh
# P6-427 entered correctly - less than 0.01 difference, don't reweigh
# P6-280 entered correctly - less than 0.01 difference, don't reweigh
# P6-121 entered correctly - same pre/post weight, don't reweigh
# P6-031 entered correctly - same pre/post weight, don't reweigh
```

##### Convert Dataset from Wide to Long #####
```{r}
r00_full_long <- r00_full_wide %>% 
  #transform data to long format with only 3 columns
  gather(key = "variable", value = "value", -house_id) %>% 
  #arrange data by house_id, descending
  arrange(house_id)

r00_full_repeated_by_phase <- r00_full_long %>%
  #this variable has no corresponding phase
  #renaming to phase 1 so it spreads below
  mutate(variable = if_else(variable == "ses_materials", 
                            "ses_materials_r00_p1", variable)) %>% 
  #this variable has no corresponding phase
  #renaming to phase 1 so it spreads below
  mutate(variable = if_else(variable == "beds_new", 
                            "beds_new_r00_p1", variable)) %>%
  #this variable has no corresponding phase
  #renaming to phase 1 so it spreads below
  mutate(variable = if_else(variable == "group", 
                            "group_r00_p1", variable)) %>%
  #separate variable to create new phase column
  separate(variable, c("variable", "phase"), sep = "_r00_p") %>%
  #separate phase and "new", then attach "new" to variable
  separate(phase, c("phase", "new"), sep = "_") %>% 
  unite("variable", c("variable", "new")) %>% 
  #remove NA from end of variables that was added above
  separate(variable, c("variable", "trash"), sep = "_NA") %>% 
  select(-"trash") %>% 
  #spread out into columns, grouped by house_id and phase
  spread(key = "variable", value = "value") %>% 
  arrange(house_id)
```

# Save datasets
```{r}
write_rds(r00_full_wide, "output/r00_full_wide.rds")
write_rds(r00_full_long, "output/r00_full_long.rds")
write_rds(r00_full_repeated_by_phase, "output/r00_full_repeated_by_phase.rds")
write_csv(r00_full_wide, "output/r00_full_wide.csv")
write_csv(r00_full_long, "output/r00_full_long.csv")
write_csv(r00_full_repeated_by_phase, "output/r00_full_repeated_by_phase.csv")
```