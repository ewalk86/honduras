---
title: "R00 Confounders Analysis"
author: "Ethan Walker"
date: "9 May 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 8, fig.height = 6)
```


```{r, message=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(purrr)
library(car)
library(forcats)
library(readxl)
library(naniar)
library(splines)
library(lubridate)
library(knitr)
library(influence.ME)
library(boxcoxmix)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

---

```{r}
#load full dataset
r00_model_data_outliers_removed <- read_rds("output/r00_model_data_outliers_removed.RDS")

# r00_full_long <- read_rds("output/r00_full_repeated_by_phase.rds")
```

```{r}
## Data prep - primary model dataset
r00_model_data <- r00_model_data_outliers_removed %>% 
  filter(phase == 1) %>%
  filter(!is.na(assigned_stove)) %>% 
  filter(!is.na(aug_index))
```

# Simple linear models between potential confounders and AIx
## Running models for Phases 1 

```{r}
aix_numeric_function <- function(df = r00_model_data, term_fun, label_fun){
  term_new <- eval(substitute(term_fun), df, parent.frame())
  
  aix_numeric <- lm(aug_index ~ as.numeric(term_new), data = df)
  
  results <- tidy(aix_numeric) %>% 
    mutate(model = if_else(term == "as.numeric(term_new)", label_fun, "na"))
  print(results)
  
  plot(aix_numeric, sub = label_fun)
}


aix_numeric_function(df = r00_model_data, term_fun = age_baseline,
                       label_fun = "age_baseline")
aix_numeric_function(df = r00_model_data, term_fun = bmi,
                       label_fun = "bmi")
aix_numeric_function(df = r00_model_data, term_fun = waist_cm,
                       label_fun = "waist_cm")
aix_numeric_function(df = r00_model_data, term_fun = salt,
                       label_fun = "salt")
aix_numeric_function(df = r00_model_data, term_fun = sugar,
                       label_fun = "sugar")
aix_numeric_function(df = r00_model_data, term_fun = manteca,
                       label_fun = "manteca")
aix_numeric_function(df = r00_model_data, term_fun = mean_temp,
                       label_fun = "mean_temp")
aix_numeric_function(df = r00_model_data, term_fun = SES_weighted_sum,
                       label_fun = "SES_weighted_sum")
```

```{r}
aix_categorical_function <- function(df = r00_model_data, term_fun){
  term_new <- eval(substitute(term_fun), df, parent.frame())
  
  aix_cat <- lm(aug_index ~ as.factor(term_new), data = df)
  
  print(tidy(aix_cat))
  
  plot(aix_cat)
}


aix_categorical_function(df = r00_model_data, term_fun = age_cat_40)
aix_categorical_function(df = r00_model_data, term_fun = bpp_cat)
aix_categorical_function(df = r00_model_data, term_fun = school_bi)
aix_categorical_function(df = r00_model_data, term_fun = ses_cat_2)
aix_categorical_function(df = r00_model_data, term_fun = ses_weighted_cat)
aix_categorical_function(df = r00_model_data, term_fun = dds_cat)
aix_categorical_function(df = r00_model_data, term_fun = bmi_cat)
aix_categorical_function(df = r00_model_data, term_fun = whr_cat)
aix_categorical_function(df = r00_model_data, term_fun = waist_cat)
aix_categorical_function(df = r00_model_data, term_fun = phys_act_cat)
aix_categorical_function(df = r00_model_data, term_fun = salt_cat)
aix_categorical_function(df = r00_model_data, term_fun = sugar_cat)
aix_categorical_function(df = r00_model_data, term_fun = manteca_cat)
```

# Simple linear models between potential confounders and AIx
## Running models for Phases 1 
## CPP has some QQ plots with a slight U shape - log and sqrt transformations didn't help much

```{r}
cpp_numeric_function <- function(df = r00_model_data, term_fun, label_fun){
  term_new <- eval(substitute(term_fun), df, parent.frame())
  
  cpp_numeric <- lm(pulse_pressure_central ~ as.numeric(term_new), data = df)
  
  results <- tidy(cpp_numeric) %>% 
    mutate(model = if_else(term == "as.numeric(term_new)", label_fun, "na"))
  print(results)
  
  plot(cpp_numeric, sub = label_fun)
}


cpp_numeric_function(df = r00_model_data, term_fun = age_baseline,
                       label_fun = "age_baseline")
cpp_numeric_function(df = r00_model_data, term_fun = bmi,
                       label_fun = "bmi")
cpp_numeric_function(df = r00_model_data, term_fun = waist_cm,
                       label_fun = "waist_cm")
cpp_numeric_function(df = r00_model_data, term_fun = salt,
                       label_fun = "salt")
cpp_numeric_function(df = r00_model_data, term_fun = sugar,
                       label_fun = "sugar")
cpp_numeric_function(df = r00_model_data, term_fun = manteca,
                       label_fun = "manteca")
cpp_numeric_function(df = r00_model_data, term_fun = mean_temp,
                       label_fun = "mean_temp")
cpp_numeric_function(df = r00_model_data, term_fun = SES_weighted_sum,
                       label_fun = "SES_weighted_sum")
```

```{r}
cpp_categorical_function <- function(df = r00_model_data, term_fun){
  term_new <- eval(substitute(term_fun), df, parent.frame())
  
  cpp_cat <- lm(pulse_pressure_central ~ as.factor(term_new), data = df)
  
  print(tidy(cpp_cat))
  
  plot(cpp_cat)
}


cpp_categorical_function(df = r00_model_data, term_fun = age_cat_40)
cpp_categorical_function(df = r00_model_data, term_fun = bpp_cat)
cpp_categorical_function(df = r00_model_data, term_fun = school_bi)
cpp_categorical_function(df = r00_model_data, term_fun = ses_cat_2)
cpp_categorical_function(df = r00_model_data, term_fun = ses_weighted_cat)
cpp_categorical_function(df = r00_model_data, term_fun = dds_cat)
cpp_categorical_function(df = r00_model_data, term_fun = bmi_cat)
cpp_categorical_function(df = r00_model_data, term_fun = whr_cat)
cpp_categorical_function(df = r00_model_data, term_fun = waist_cat)
cpp_categorical_function(df = r00_model_data, term_fun = phys_act_cat)
cpp_categorical_function(df = r00_model_data, term_fun = salt_cat)
cpp_categorical_function(df = r00_model_data, term_fun = sugar_cat)
cpp_categorical_function(df = r00_model_data, term_fun = manteca_cat)
```
